<HTML><HEAD>
<meta charset="utf-8" >
<meta name="viewport" content="width=device-width" >
<link rel="stylesheet" href="../assets/usage.css">
<TITLE>Common Formats -- IM v6 Examples</TITLE>
<LINK REL="icon" HREF="../img_www/favicon.ico" type="image/x-icon">
<LINK REL="shortcut" HREF="../img_www/favicon.ico" type="image/x-icon">
<LINK REL="canonical" HREF="https://imagemagick.org/Usage/formats/">
</HEAD><body><main class="container"><div class="magick-template"><div class="magick-header">

<H1>ImageMagick v6 Examples -- <BR>
    <IMG SRC="../img_www/space.gif" width=50 height=1>
    Common Image Formats</H1>

<DIV ALIGN=justify>

<DL>
<DT><B>Index</B>
<DT><A HREF="../"
    ><IMG SRC="../img_www/granitesm_left.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > ImageMagick Examples Preface and Index</A>
<DD><A HREF="#summary"
    ><IMG SRC="../img_www/granitesm_right.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > A Brief Summary of Common Image File Formats</A>
<DD><A HREF="#gif"
    ><IMG SRC="../img_www/granitesm_right.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > GIF Image File Format</A>
    <UL>
    <LI><A HREF="#gif_colors"
        > GIF Limited Color Table</A>
    <LI><A HREF="#gif_trans"
        > GIF Transparency Color</A>
    <LI><A HREF="#boolean_trans"
        > GIF Boolean Transparency</A>
    <LI><A HREF="#bgnd"
        > GIFs on a solid color background </A>
    <LI><A HREF="#bg_pattern"
        > GIFs on a background pattern </A>
    <LI><A HREF="#dither"
        > GIFs for non-specific backgrounds </A> (transparency dithering)
    <LI><A HREF="#gif_non-im"
        > Non-ImageMagick GIF Processing</A>
    <LI><A HREF="#gif_offsets"
        > GIF Offset Handling</A>
    <LI><A HREF="#gif87"
        > Related GIF Output Formats - GIF87</A>
    </UL>
<DD><A HREF="#jpg"
    ><IMG SRC="../img_www/granitesm_right.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > JPEG Image File Format</A>
    <UL>
    <LI><A HREF="#jpg"
        > JPEG compression</A>
    <LI><A HREF="#jpg_trans"
        > JPEG transparency - NOT</A>
    <LI><A HREF="#jpg_color"
        > JPEG Color Distortion</A>
    <LI><A HREF="#jpg_read"
        > Reading JPEG images</A>
    <LI><A HREF="#jpg_write"
        > Writing JPEG images</A>
    <LI><A HREF="#jpg_formats"
        > Related JPEG Output Formats</A> (A quick summary)
    <LI><A HREF="#jpg_non-im"
        > Non-ImageMagick JPEG Processing</A> (A quick summary)
    <LI><A HREF="#jpg_lossless"
        > Lossless JPEG Processing</A>

    </UL>
<DD><A HREF="#png"
    ><IMG SRC="../img_www/granitesm_right.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > PNG Image File Format</A>
    <UL>
    <LI><A HREF="#png_quality"
        > PNG compression</A>
    <LI><A HREF="#png_compress"
        > PNG better compression</A>
    <LI><A HREF="#png_www"
        > PNG, Web Browsers and Transparency</A>
    <LI><A HREF="#png_offsets"
        > PNG and the Virtual Canvas</A>
    <LI><A HREF="#png_density"
        > PNG Resolution, Density and Units</A>
    <LI><A HREF="#png_formats"
        > PNG Sub-Formats</A>
    <LI><A HREF="#png_write"
        > Writing PNG Image Controls</A>
    <LI><A HREF="#png_non-im"
        > Non-ImageMagick PNG Processing</A>
    </UL>
<DD><A HREF="#profiles"
    ><IMG SRC="../img_www/granitesm_right.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > Image Profiles</A>
    <UL>
    <LI><A HREF="#color_profile"
        > Changing Colorspace of an Image</A> -- RGB &lt;=&gt; CMYK conversion
    <LI><A HREF="#profile_iptc"
        > IPTC Profiles</A>
    </UL>
<DD><A HREF="#vector"
    ><IMG SRC="../img_www/granitesm_right.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > A Word about Vector Image Formats</A>
<DD><A HREF="#other"
    ><IMG SRC="../img_www/granitesm_right.gif" BORDER=0 WIDTH=15 HEIGHT=15
    > Other Image File Formats</A>
    <DL><DD>
    <A HREF="#ps" >Postscript (PS),&nbsp; Encapsulated PS (EPS),&nbsp; PDF</A>,
    <BR>
    <A HREF="#pbmplus" >PbmPlus/NetPBM (PBM, PGM, PPM, PNM, PAM)</A>,
    <BR>
    <A HREF="#tiff"   >TIFF</A>,&nbsp;&nbsp;
    <A HREF="#bmp"    >BMP</A>,&nbsp;&nbsp;
    <A HREF="#ico"    >ICO</A>,&nbsp;&nbsp;
    <A HREF="#crw"    >RAW Digital Image (CRW,CR2,etc)</A>,
    <BR>
    <A HREF="#mpeg"   >MPEG, M2V and AVI</A>,&nbsp;&nbsp;
    <A HREF="#mng"    >MNG</A>,&nbsp;&nbsp;
    <A HREF="#dpx"    >Digital Picture Exchange (DPX)</A>,
    <BR>
    <A HREF="#psd"    >PSD</A>,&nbsp;&nbsp;
    <A HREF="#wmf"    >WMF</A>,&nbsp;&nbsp;
    <A HREF="#swf"    >MacroMedia Flash (SWF)</A>,
    <BR>
    <A HREF="#html"   >Webpage HTML Conversion</A>,&nbsp;&nbsp;
    <A HREF="#pcl"    >PCL Printing Format</A>,
    <BR>
    <A HREF="#pcd"    >Kodak PhotoCD Format (PCD)</A>,&nbsp;&nbsp;
    <A HREF="#rgb"    >Raw RGB Data</A>,
    </DD></DL>
</DL></P>

Many of the image file formats have particularities which you need to keep in
mind when using that format. This page deals with these special needs,
and ways to improve results in those formats. </P>

<HR><!-- ---------------------------------------------------------------- -->

<A NAME="summary"></A>
<H2>A Brief Summary of Common Image File Formats</H2>

For an introduction to reading and writing image formats see <A
HREF="../files/" >Image File Formats</A>.  While a list of all the
ImageMagick file formats are given on the <A
HREF="https://imagemagick.org/script/formats.php" >IM Image Formats
Page</A>. </P>

Here is a very quick summary of the most common 'normal' image file formats,
as well as their general advantages and disadvantages...

<DL>
<DT><A HREF="#gif" ><B>GIF</B></A>
<DD>This format is extremely common, and has been around for so long that all
    image handling programs understand it. But only uses a limited number of
    colors (a 256 color table) and only saves using 8 bit quality.  However
    its built-in run-length encoding allows it to save images with only a few
    colors very efficiently.  </P>

    While the format has transparency, it only understands Boolean (on/off)
    transparency and so consequently suffers from 'aliasing' or 'jaggies'.
    Plain text with thin lines suffers badly when saved as a transparent GIF
    image.  The only solution to this problem is to tie the GIF image to a
    specific background of the web page in which it is used. </P>

    The GIF format can save multiple images to form an animation sequence, and
    for this purpose also saves the image canvas size and offset (page)
    information. Note however that negative offsets are not supported, and
    attempts to do so resets that offset to zero. </P>

    Its best used for small images of cartoons, line drawings, and small
    icons, all of which have limited colors, and will allow it to compress
    well.  Its use however should be avoided when a newer format like PNG is
    available. </P>

<DT><A HREF="#jpg" ><B>JPEG</B></A>
<DD>Does not handle transparency at all.  The image is equivalent to using
    "<CODE><A HREF="../option_link.cgi?matte" >+matte</A></CODE>" operation to
    remove the alpha channel, so any background transparency commonly becomes
    black depending on the image processing used to generate the image.  </P>

    This format is also 'lossy', producing edge effects on sharp lines and
    borders and thus should not be used for any intermediate image
    processing, or storage of image originals (unless they were already in
    this format).  </P>

    It is well suited to long term storage of real life photographs, but avoid
    it if you plan to further process the image, or the image contains large
    areas of solid colors. </P>

<DT><A HREF="#png" ><B>PNG</B></A>
<DD>This format is intended to eventually replace older formats like GIF and
    TIFF.  It is a modern format capable of handling 16 bit quality with four
    color channels allowing the full use of semi-transparent colors.  It also
    includes a huge number of lossless image compression options.  </P>

    Its biggest disadvantage is that it is still relatively new, such that the
    Microsoft IE (v6) web browser does not automatically handle it correctly.
    However a fix is available for this problem. </P>

    The format does not save canvas size information (where GIF does), but it
    does save the canvas offsets and even negative offsets (which GIF does
    not), though some web browsers have problems when a negative offset is
    used, so this is not recommended for a final image to be displayed in a
    browser.  </P>

    For saving intermediate 'layered' images, the ability to save negative
    offsets can be very important and is often much more important than its
    not saving canvas size information. </P>

<DT><B>MNG</B>
<DD>This is the multi-image format for PNG, and allows animations to movie
    quality levels and speed. </P>

    <I>A simple example of using MNG is wanted, so if you have one mail
    me.</I> </P>

    The MNG animation format appears to becomeing obsolete and has been
    abandoned by some web broswers such as FireFox. </P>


<DT><A HREF="#tiff"><B>TIFF</B></A>
<DD>This is the Image interchange format that was developed to transfer high
    quality images between programs before any serious image formats were
    available.  Unfortunately, because of this beginning, the format has been
    modified with a haphazard array of features and compression
    styles and no programs understands them all. </P>

    The format is now pretty well only use by "<CODE><A
    HREF="http://www.adobe.com/products/photoshop/" >Photoshop</A></CODE>" on
    windows platforms, and this is the only source that provides any sort of
    standard reference for the TIFF image format. </P>

    TIFF files can handle multiple images, though few applications other than
    IM handle multiple image TIFFs. </P>

    Generally, unless the internal format of the TIFF image is kept relatively
    basic, there is no guarantee that a TIFF file generated by one program
    will be usable by another program, including IM or even "<CODE><A
    HREF="http://www.adobe.com/products/photoshop/" >Photoshop</A></CODE>"
    itself.  As such I do not recommend this format period!  I suggest you
    use some other format than TIFF (or JPEG), especially for long term
    storing of images. </P>

    The few notes I have on this format and its problems are provided below in
    the <A HREF="#tiff">Miscellaneous Formats, TIFF</A> section. These usage
    notes were found in the IM mailing lists and forums, as I myself don't use
    or need to use TIFF. </P>

<DT><B>Video Formats</B>
<DD>Other movie quality animation formats generally based on using lossy
    compression to reduce the size (and quality) of the movie. Both formats
    are in a constant state of flux, improvements and security limiting
    features, making any form of processing difficult. </P>

    At last count there was more than 200 video format 'codecs' that are in
    general use for one purpose or another. </P>

    Because of this IM does not directly handle this format, instead it relies
    on other software packages, to handling the processing of the individual
    frames into and out of the animations. These 'delegate' programs include
    "<CODE>mpeg2decode</CODE>", "<CODE>mpeg2encode</CODE>", and
    "<CODE>mplayer</CODE>".  </P>

    See <A HREF="#mpeg" >MPEG, M2V, and AVI</A> below). </P>
</DL>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28
    ><IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
  Some system (like ubuntu) disable the use specific image file formats using
  a security policy.  Type <CODE>magick -list policy</CODE> to see what
  policies and where they are set from are present on your system.
</I></FONT></TD></TR></TABLE></P>

<HR><!-- ---------------------------------------------------------------- -->

<A NAME="gif"></A>
<H2>GIF Image File Format</H2>

The GIF format is a very widely known image file format, as it has been around
for a very very very long time (from the late 1980's).  It is often picked for
images which are to be displayed on web pages that involve transparency or
image animation. It is also about the only format absolutely universally
understood by all web browsers. </P>

Unfortunately it is not a very good format for anything but line drawings,
figures, diagrams, and cartoons.  That is because it is limited to a maximum
of 256 colors, one of which is usually flagged as being transparent.  </P>

Flagging one specific color in the image as transparent has some drawbacks.
If the color to use as transparent is badly chosen, it can result in other
parts of the image being transparent when that was not intended.  Care must be
taken to ensure that does not happen. </P>

Further more, the transparency ability is 'Boolean', which basically means it
is either fully on, or fully off.  Semi-transparent colors are just not
possible, and if present need to be made either transparent or opaque. That
means the format can not provide any form of anti-aliasing of edges of an
image, usually resulting in a bad case of the 'jaggies'. (See <A
HREF="../antialiasing/"> Anti-Aliasing</A>) </P>

Because the "GIF" image formats color limitations causes so many problems,
especially from a high quality image processing package like ImageMagick, I
would like to say up front... </P>

<DIV ALIGN=center><B>
                Avoid GIF format, if at all possible.
<BR>      If you must use it, do so only as the final step.
</B></DIV></P>

Finally for a long time the compression algorithm used by GIF was patented.
Consequently it was not available for use by many image processing programs,
such as ImageMagick.  Thus very old IM programs will output GIF format images
un-compressed, and thus using more disk space than it should.  You can fix
this using a GIF batch compression program such as "<CODE><B><A
HREF="http://www.lcdf.org/gifsicle/" >Gifsicle</A></B></CODE>" or "<CODE><B><A
HREF="http://utter.chaos.org.uk/~pdh/software/intergif.htm"
>InterGIF</A></B></CODE>".  However as the patent expired completely in
mid-2004, the current release of IM has the GIF image compression re-enabled
again. </P>

The image compression is also rather simple, and works best on images with
large areas of solid, unchanging colors. Or on simple repeated patterns of the
same set of colors, such as you get using <A
HREF="../quantize/#ordered-dither" >Ordered Dithering</A> (not the default
dither in IM). </P>

Finally GIF images can save multiple images in the one file. And this is used
to generate <A HREF="../anim_basics/" >GIF Animations</A> as understood by
pretty well all web browsers, since the technique was first introduction by
the very old "Netscape" browser. </P>

<B>In Summary</B> The GIF image file format with its limited color table,
Boolean transparency, and simplistic compression (if enabled), makes it ideal
for small images, such as thumbnails, and especially "cartoon-like" icons,
logos, and symbols images with large areas of solid colors.  Its animation
abilities also make it an ideal method of generating flashy attention grabbing
logos and advertisements you see all over the World Wide Web. </P>

For anything else its limitations make it a poor image file format and you may
be better moving to JPEG, PNG, or a video image format for your needs. </P>

<A NAME="gif_colors"></A>
<H2>GIF Limited Color Table</H2>

<PRE>
FUTURE: color reduction examples -- reference basic color dithering
Ensuring that a specific color is present in the final GIF image
Map color tables to color reduce.
See <A HREF="../quantize/#colors" >Color Quantization</A>.
</PRE>

See <A HREF="../advanced/#3d-bullets" >Advanced 3-D Bullet Scripting</A> for
an example of generating multiple images over a range of colors.  This
technique can also be used to auto-magick your image into multiple images for
many different backgrounds colors and patterns. </P>

<!-- <CODE EXECUTE ASSERT>
  [ `magick -size 1x256 gradient: gif:- |\
       magick identify -format %k - ` -eq 256 ] || echo >&2 \
    "ASSERTION FAILURE: GIF did not save a 256 color gradient"
  [ `magick -size 1x256 gradient: -transparent Gray30 gif:- |\
       magick identify -format %k - ` -eq 256 ] || echo >&2 \
    "ASSERTION FAILURE: GIF did not save a 256 color gradient (with trans)"
</CODE> -->

<A NAME="gif_trans"></A>
<H2>GIF Transparency Color</H2>

For example here we use magick identify to extract the transparent color, and the
color table a particular GIF image file used to represent transparency.
The perl script extracts just the specific fields of interest (which can be
multi-line).

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%">
<TR valign="top"><TD WIDTH=10% ALIGN=justify ROWSPAN=2></TD>
               <TD WIDTH=80% ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE OUT=hand_point.txt>
  magick identify -verbose hand_point.gif |\
      perl -0777 -ne 's/^  //gm; \
            print $& while /^(Colors|Alpha|Colormap):.*?(?=^\S)/gms'
</CODE></PRE></TD></TR></TABLE></TD><TD ALIGN=center ROWSPAN=2>
  <A HREF="../images/hand_point.gif"
      ><IMG SRC="../images/hand_point.gif"
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</TD></TR><TR><TD>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD>
    <A HREF="hand_point.txt"
      ><IMG SRC="hand_point.txt.gif"
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></TD></TR></TABLE></P>

As you can see, a transparent grey color ('<CODE>#CCCCCC00</CODE>') was used
for this image and this color has its own separate entry in the color table.
</P>

You can also see that even though this image only uses 5 colors (one
transparent), the color table used is for 8 colors.  that is because the GIF
file format can only use a color table that is a power of 2 in size.  That is
the color table is always 2, 4, 8, 16, 32, 64, 128 or 256 color entries in
size. </P>

As such the last 3 color table entries are not used. Actually they are just
not refered to.  In some cases these unused entries may not be the last three
entries in the color table, and could actually contain any color value. You
can also actually have duplicate color values, though IM typically removes any
such duplicate color entries if it processes the image in some way. </P>

As of IM version 6.2.9-2 (and in some older versions), IM will preserve the
color table, and more specifically the transparent color value, whenever it
reads, processes and writes a GIF image.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%">
<TR valign="top"><TD WIDTH=10% ALIGN=justify ROWSPAN=2></TD>
               <TD WIDTH=80% ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE  OUT=hand_white.txt>
  magick hand_point.gif    -fill white -opaque wheat   hand_white.gif
  magick identify -verbose hand_white.gif |\
      perl -0777 -ne 's/^  //gm; \
            print $& while /^(Colors|Alpha|Colormap):.*?(?=^\S)/gms'
</CODE></PRE></TD></TR></TABLE></TD><TD ALIGN=center ROWSPAN=2>
  <A HREF="hand_white.gif"
      ><IMG SRC="hand_white.gif"
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</TD></TR><TR><TD>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD>
    <A HREF="hand_white.txt"
      ><IMG SRC="hand_white.txt.gif"
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></TD></TR></TABLE></P>

As you can see even though the image was modified (all '<CODE>wheat</CODE>'
color pixels were replaced with a '<CODE>white</CODE>' color) the transparent
color used was preserved </P>

However if the final image has no transparency, the transparency color entry
('<CODE>Alpha:</CODE>') in the color table is completely removed.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%">
<TR valign="top"><TD WIDTH=10% ALIGN=justify ROWSPAN=2></TD>
               <TD WIDTH=80% ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE  OUT=hand_flatten.txt>
  magick hand_point.gif   -background white -flatten    hand_flatten.gif
  magick identify -verbose hand_flatten.gif |\
      perl -0777 -ne 's/^  //gm; \
            print $& while /^(Colors|Alpha|Colormap):.*?(?=^\S)/gms'
</CODE></PRE></TD></TR></TABLE></TD><TD ALIGN=center ROWSPAN=2>
  <A HREF="hand_flatten.gif"
      ><IMG SRC="hand_flatten.gif"
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</TD></TR><TR><TD>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD>
    <A HREF="hand_flatten.txt"
      ><IMG SRC="hand_flatten.txt.gif"
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></TD></TR></TABLE></P>

If you like to change the transparent color that the GIF file format is using,
you can use the "<CODE><A HREF="../option_link.cgi?transparent-color"
>-transparent-color</A></CODE>" output setting (added IM v6.2.9-2).   For
example...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%">
<TR valign="top"><TD WIDTH=10% ALIGN=justify ROWSPAN=2></TD>
               <TD WIDTH=80% ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE OUT=hand_wheat.txt>
  magick hand_point.gif -transparent-color wheat  hand_wheat.gif
  magick identify -verbose hand_wheat.gif |\
      perl -0777 -ne 's/^  //gm; \
            print $& while /^(Colors|Alpha|Colormap):.*?(?=^\S)/gms'
</CODE></PRE></TD></TR></TABLE></TD><TD ALIGN=center ROWSPAN=2>
  <A HREF="hand_wheat.gif"
      ><IMG SRC="hand_wheat.gif"
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</TD></TR><TR><TD>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD>
    <A HREF="hand_wheat.txt"
      ><IMG SRC="hand_wheat.txt.gif"
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></TD></TR></TABLE></P>

As you can see even though the result is not visibly different from the
original, the transparent color was changed to a fully-transparent version of
the '<CODE>wheat</CODE>' color. </P>

If you look closely you will also see that the image now has two
'<CODE>wheat</CODE>' or '<CODE>#F5DEB3</CODE>' colors in its color table.
That is, one transparent wheat and one opaque wheat.  As of IM version
6.2.9-2, this presents no problem. Though only one transparent color can be
defined by the GIF image file format. </P>

Why would you do that?  Because some very old web browsers and graphic
programs do not understand GIF transparency. So this option lets you set what
color the transparent areas should be in that situation. </P>

Typical choices for the transparent color are '<CODE>white</CODE>' for modern
browsers, OR more typically '<CODE>grey75</CODE>' ('<CODE>#BFBFBF</CODE>'),
which was the original "<CODE>mosaic</CODE>" web browser page color.  Other
popular transparent color choices are '<CODE>grey</CODE>'
('<CODE>#BEBEBE</CODE>'), and '<CODE>silver</CODE>' ('<CODE>#C0C0C0</CODE>')
which is what the 'hand' image above used.  This shows just how popular that
specific area of the gray-scale color range is for the transparent color. </P>

<I>FUTURE: add link to color selection.</I>  </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28>
    <IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
  Before IM v6.2.9-2, and the creation of the "<CODE><A
  HREF="../option_link.cgi?transparent-color" >-transparent-color</A></CODE>"
  output setting, IM would typically save the transparency of an image as
  the special color '<CODE>none</CODE>' (fully-transparent black), which is
  not particularly nice when transparency fails.
</I></FONT></TD></TR></TABLE></P>

Note that setting "<CODE><A HREF="../option_link.cgi?transparent-color"
>-transparent-color</A></CODE>" does NOT add any transparency to a GIF image,
nor does it magick the specified color to become transparent. All the option
does is specify what color should placed in the color table for the color
index that is used representing the transparent colors in a GIF image. </P>

If you want to change a specific (exact) color to become transparent, then use
the "<CODE><A HREF="../option_link.cgi?transparent" >-transparent</A></CODE>"
<A HREF="../color_basics/#replace" >Color Replacement Operator</A>. </P>


<A NAME="trans"></A>
<A NAME="boolean_trans"></A>
<H2>GIF Boolean Transparency</H2>

Because the GIF format does NOT understand semi-transparent colors, and as
ImageMagick by default generates semi-transparent color as part of its
normal <A HREF="../antialiasing/" >Anti-Aliasing Methods</A>, when you save a
image to this format it will often come out horrible looking. </P>

For example, here I draw a simple black circle on a transparent background.
Also I will generate an enlarged view of the edge of the images, to make it
clear what is happening. </P>

First I will output using the PNG format...
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick -size 60x60 xc:none -fill white -stroke black \
          -draw 'circle 30,30 5,20' circle.png
  magick circle.png -crop 10x10+40+3 +repage  -scale 600%  circle_mag.png
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
   <A HREF="circle.png"
      ><IMG SRC="circle.png"       WIDTH=60  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="circle_mag.png"
      ><IMG SRC="circle_mag.png"   WIDTH=60  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=0 BORDER=1 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

As you can see the edge of the circle on the left drawn (in PNG format)
as a very clean looking (though slightly fuzzy) edge to the image.  You can
see the semi-transparent pixels in its enlargement. </P>

Now lets output the same image using the "GIF" image format...
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick -size 60x60 xc:none -fill white -stroke black \
          -draw 'circle 30,30 5,20' circle.gif
  magick circle.gif -crop 10x10+40+3 +repage  -scale 600%  circle_mag.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
   <A HREF="circle.gif"
      ><IMG SRC="circle.gif"        WIDTH=60  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="circle_mag.gif"
      ><IMG SRC="circle_mag.gif"   WIDTH=60  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=0 BORDER=1 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

The result is that the circle has a very sharp stair case effects along the
outside edge of the circle, while the inside remains properly anti-aliased.
</P>

Basically while PNG format can save semi-transparency pixel information,
GIF cannot.  The GIF image format can only save a single pure transparent
color. In other words... </P>

<DIV ALIGN=center><B>
           GIF format has an on/off or Boolean transparency
</B></DIV></P>

If you look more closely at the resulting GIF, you will find that the
semi-transparent pixels could have either become fully-transparent or
full-opaque. </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28
    ><IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    What ImageMagick actually does with semi-transparent pixels depends on
    just what version of IM you are using. It was for a long time not properly
    defined and what a version did, often depended on the last 'bug fix' that
    was applied due to bug reports from users. </P>

    As of v6.2.9-6 ImageMagick should by default threshold the image at a 50%
    level for both GIF and XPM image formats.  This has become the accepted
    standard as used by image handlers, while still allowing you to set your
    own methods of dealing with the transparency problems of the GIF file
    format.
</I></FONT></TD></TR></TABLE></P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/expert.gif"   WIDTH=23 HEIGHT=26
    ><IMG SRC="../img_www/space.gif"   WIDTH=17 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    Because of the GIF limitations, IM performs the following set of
    operations before saving to the GIF file format...
    <PRE>    -channel A -threshold 50%
    if (fully-)transparent pixels are present it then...
      -quantize transparent -colors 255
    otherwise if no transparent pixels present...
      -colors 256</PRE>

    The -colors quantization process automatically does nothing if less that
    that many colors are present in the image. Nor will it do anything if the
    image has a valid colormap (as assigned by "<CODE>+/-map</CODE>"). </P>

    It also does not attempt to use a common color map for multi-image GIF
    files. As such if the colors are very different from one frame to the
    next, a local color table may be added to each individual image saved into
    the GIF file format. </P>

    Also the settings used in the above are not permanent just temporary for
    the image being saved. That is if you used "<CODE>-write image.gif</CODE>"
    the settings used during the process do not effect later operations.

</I></FONT></TD></TR></TABLE></P>

You may like to do the thresholding yourself, and this is recommended if you
are not certain of what version of IM (especially older versions) you are
using.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick -size 60x60 xc:none -fill white -stroke black \
          -draw 'circle 30,30 5,20' \
          -channel A -threshold 50%  circle_threshold.gif
  magick circle_threshold.gif -crop 10x10+40+3 +repage \
          -scale 600%   circle_threshold_mag.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
   <A HREF="circle_threshold.gif"
      ><IMG SRC="circle_threshold.gif"        WIDTH=60  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="circle_threshold_mag.gif"
      ><IMG SRC="circle_threshold_mag.gif"    WIDTH=60  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=0 BORDER=1 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

The above example performs the same "<CODE><A
HREF="../option_link.cgi?threshold" >-threshold</A> 50%</CODE>" on the alpha
channel that IM now does automatically, that is if a pixel is more than 50%
transparent, it will be made fully-transparent (using the color given by the
"<CODE><A HREF="../option_link.cgi?transparent-color"
>-transparent-color</A></CODE>" setting if defined. </P>

However you now have control of the threshold level as you like.
</P>

Thresholding the alpha channel at 50% works well for most types of images.
Especially those with a simple edge, but the technique breaks down rather
badly, when you need to deal with large areas of semi-transparent pixels.
This is what the most of the following examples for GIF handling will look at.
</P>

For example suppose we want to save an image with a large <A
HREF="../fonts/#fuzzy_shadow" >fuzzy semi-transparent shadow</A> such as this
image (in PNG format)...

<!--  The shadow equivalent -- not as much control over the final size.
  magick -background none -fill white -stroke black \
          -font Candice -pointsize 50 label:A \
          \( +clone -background black -shadow 100x5+5+5 \) +swap \
          -background none -flatten  -crop 70x60+10+0 +repage   a.png
-->
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick -size 70x60 xc:none -font Candice -pointsize 50 \
          -fill black -annotate +10+45 'A' -channel RGBA  -blur 0x5 \
          -fill white -stroke black -draw "text 5,40 'A'"   a.png
</CODE></PRE></TD></TR></TABLE></TD><TD>
   <A HREF="a.png"
      ><IMG SRC="a.png"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

If you just magick this letter directly to GIF format or even use a "<CODE><A
HREF="../option_link.cgi?threshold" >-threshold</A></CODE>" operation to
control the Boolean transparency, you will be sorely disappointed.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png  a.gif
  magick a.png -channel A -threshold 75%   a_threshold.gif
</CODE></PRE></TD></TR></TABLE></TD><TD>
   <A HREF="a.gif"
      ><IMG SRC="a.gif"              WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_threshold.gif"
      ><IMG SRC="a_threshold.gif"    WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

<!-- <CODE EXECUTE ASSERT>
  # The number of transparent pixels in the image changes.
  # from  2786 Jan06 (FC5),   2794 in Dec06 (FC6),   2775 in June07 (FC7)
  # These appear to be font changes due to OS upgrades.
  # (Better non-font related test needed)
  a50=`magick a.png -fill black -colorize 100% \
              -channel A -threshold 50% -verbose info: | \
      sed -n '/Histogram:/,/Colormap:/s/^ *\([^ :]*\):.*none.*/\1/p;'`; \
  [ "$a50" -lt 2750 -o "$a50" -gt 2800 ] && echo >&2 \
    "ASSERTION FAILURE: 50% threshold not in expected range"; \
  a=`magick identify -verbose a.gif | \
      sed -n '/Histogram:/,/Colormap:/s/^ *\([^ :]*\):.*none.*/\1/p;'`; \
  [ "$a" != "$a50" ] && echo >&2 \
    "ASSERTION FAILURE: GIF did not threshold alpha at 50%!"
</CODE> -->

The first image is a normal save to GIF format, which as you can see
thresholded the semi-transparent pixels at '<CODE>50%</CODE>', the second
image was thresholded at '<CODE>75%</CODE>' allowing more semi-transparent
pixels to become fully-opaque (or visible). </P>

If you just want to remove all the semi-transparent pixels (EG the shadow)
you could try something like a "<CODE>-threshold 15%</CODE>", to remove just
about all semi-transparent pixels.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png -channel A -threshold 15%   a_no_shadow.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
   <A HREF="a_no_shadow.gif"
      ><IMG SRC="a_no_shadow.gif"    WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

Most other solutions to the GIF Boolean transparency problem is to
inextricably tie the image to the background color of the web page on which it
lives.  Methods for doing this are complex and tricky, and this is what we
will now look at. </P>


<A NAME="bgnd">
<H3>GIFs on a solid color background</H3>
</A>

What we would really like to to somehow preserve the shading of the
semi-transparent and anti-aliased pixels, and still magick display it nicely on the
WWW.  To do this we have to be a little tricky. </P>

The typical solution is to match the image to the background on which you are
going to magick display the image on.  This is simple to do, just overlay the image
onto a background of the appropriate color, before you save it to the GIF
format.  This removes the need for any form of transparency and the whole
thing becomes a non-issue.  Of course the limited number of colors is still an
issue, but often not a big problem.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png -background LightSteelBlue -flatten  a_overlay.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
   <A HREF="a_overlay.gif"
      ><IMG SRC="a_overlay.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

See just about perfect! </P>

Of course for this method to work correctly you need to know what exactly the
background color the image will be used on.  Also after we are finished the
image will not be much good on any other background.  A big sacrifice to make.
</P>

<A NAME="bg_pattern">
<H3>GIFs on a background pattern</H3>
</A>

But what if you are using some pattern for a background, instead of a simple
solid color? </P>

You could try positioning the overlay onto a copy of the background pattern so
that the pattern in the resulting image matches the pattern of the web page.
However that would require a lot of trial and error to get the background in
the image to match up with the web page. Also you could only guarantee it to
work for a particular browser, and then only that specific version of the
browser.  Not a good idea for a web page, so don't even bother to try. I
certainly won't. </P>

Instead of trying to do a perfect match-up with the background pattern, lets
just overlay it onto a color that at least matches the background we intend to
use. </P>

For example lets overlay our image onto a 'typical' bubble like background
pattern.  But first we need to know the average color of this background.  A
simple way to find this color is to just <A HREF="../resize/#scale" >scale</A>
the image down to a single pixel, then read the resulting color.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE OUT=bg_color_avg.txt>
  magick bg.gif -scale 1x1\! -depth 8 txt:-
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE>
   <A HREF="bg_color_avg.txt"
      ><IMG SRC="bg_color_avg.txt.gif"
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</PRE></TD></TR></TABLE>
</DIV></P>

See <A HREF="../files/#txt" >IM Pixel Enumeration Text Format</A> for more
information on the special "<CODE>txt:</CODE>" output format used. </P>

Now lets set the background transparency of the image using "<CODE><A
HREF="../option_link.cgi?flatten" >-flatten</A></CODE>".

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png  -background '#BABBD7' -flatten  a_bg.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD></TD><TD>
<TABLE BORDER=1 CELLPADDING=10 BACKGROUND="../images/bg.gif" ALIGN=center>
<TR><TD>
   <A HREF="a_bg.gif"
      ><IMG SRC="a_bg.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE>
</TD></TR></TABLE>

I have setup the web page to overlay our image on that background, even though
that background is NOT part of the image itself. </P>

Though the background color used matched the general color of the background
pattern, it still has a very obvious rectangle of solid color, devoid of the
the background pattern, around it. </P>

One practical solution is to declare the color we overlay, as the "<CODE><A
HREF="../option_link.cgi?transparent" >-transparent</A></CODE>" color in the
GIF output. By doing this we remove the 'squareness' of the image.  Also
adding a small <A HREF="../color_basics/#fuzz" >fuzz factor</A> improves the
result and adjusts the amount of space the transparent color uses, in the same
way threshold did above.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png  -background '#B9BBD6' -flatten \
          -fuzz 5%   -transparent '#B9BBD6'   a_bg_trans.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD></TD><TD>
<TABLE BORDER=1 CELLPADDING=10 BACKGROUND="../images/bg.gif" ALIGN=center>
<TR><TD>
   <A HREF="a_bg_trans.gif"
      ><IMG SRC="a_bg_trans.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE>
</TD></TR></TABLE></P>

This is typically good enough to handle transparency in most GIF images,
though it does tie the image to a specific background color. </P>

In essence we are using the transparency to set a basic outline shape to the
image, rather than a true transparency. By using a color for the overlay and
GIF transparency so that it matches the background pattern means it is
no longer clear exactly where the image stops, and the background pattern
starts. </P>

<BR>

Be cautious however with the "<CODE><A HREF="../option_link.cgi?fuzz"
>-fuzz</A></CODE>" setting, as too much and you can end up with more than just
the outside of your image becoming transparent!

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png  -background '#B9BBD6' -flatten \
          -fuzz 25%  -transparent '#B9BBD6'   a_bg_overfuzz.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD></TD><TD>
<TABLE BORDER=1 CELLPADDING=10 BACKGROUND="../images/bg.gif" ALIGN=center>
<TR><TD>
   <A HREF="a_bg_overfuzz.gif"
      ><IMG SRC="a_bg_overfuzz.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE>
</TD></TR></TABLE></P>

It will also fail if you used a color close to the background colour within
the image itself.  As such this technique is <I>not recommended</I> for
general images, but only in specific cases. </P>

To solve this problem we use a '<CODE><A HREF="../draw/#matte" >matte
floodfill</A></CODE>' to set the areas we want transparent.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png  -background '#B9BBD6' -flatten \
          -fuzz 25%  -draw 'fill none  matte 0,0 floodfill' a_bg_none.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD>&nbsp;</TD><TD>
<TABLE BORDER=1 CELLPADDING=10 BACKGROUND="../images/bg.gif" ALIGN=center>
<TR><TD>
   <A HREF="a_bg_none.gif"
      ><IMG SRC="a_bg_none.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE>
</TD></TR></TABLE></P>

Now as long as the borders of our image do not 'leak' we can use similar
colors inside the image as our background, and not have them turn transparent
on us, due to 'over fuzzing'. </P>

Of course if our image has 'holes' in it, then those holes will also have to
be taken care of too.  In which case the previous 'fuzzed transparency' may
work better. </P>

Did say handling a GIF transparency color is easy!  NOT! </P>

<BR>

An alternative technique especially for images with a sharp anti-aliased edge
is to simply add a minimum outline of the background color.  See <A
HREF="../masking/#outline" >Outline or Halo Transparency</A>. </p>

<BR>

<B>Remove the Background Color</B>... </P>

Trying an remove a specific background color from an existing GIF image is not
easy.  It is especially difficult if the overlaid image also contains the
background color, as you then don't really know what is background and what
isn't. </P>

The best solution is to get a copy of the same GIF overlay on two different
and well known background colors.  With two such images, you can recover the
original overlay and all its semi-transparent pixels perfectly. See <A
HREF="../masking/#two_background" >Background Removal using Two
Backgrounds</A>. </P>

If you don't have two such images, then you can not perfectly recover the
images semi-transparency, but there are techniques that can do a reasonable
though imperfect job.  For this see the other sections of <A
HREF="../masking/#bg_remove" >Background Removal</A>. </P>

<BR>

<A Name="dither">
<H3>GIFs for non-specific backgrounds
<FONT SIZE=2>(or Dithering the Transparency)</FONT></H3>
</A>

<PRE>FUTURE: This will move into a more generalise (non-GIF specific), alpha
dithering section.</PRE>

The biggest problem with the above is that it would only work if you happened
to know exactly what color the background, or background pattern your image
will be used on.  If you don't know all is not lost. </P>

As you saw above, threshold does not work well for an image with a very large
area of transparency, such as a fuzzy shadow. But another technique known as
dithering can, and does NOT require knowledge of the background it will be
used on. </P>

Basically dithering limits the transparency to on/off values, creating an
effect of semi-transparency over a larger area using a pattern if pixels.
In other words it fakes semi-transparency. </P>

This method was exampled in what is now known as the "<A
HREF="http://pmt.sourceforge.net/opossum/" >Opossum Examples</A>".
Unfortunately these examples did not actually give the commands that were used
to generate the example. For completeness I will attempt to demo them again
here.  </P>

The "<CODE><A HREF="../option_link.cgi?monochrome" >-monochrome</A></CODE>"
operator converts all colors in an image into a pure black and white
"Floyd-Steinberg error correction dither".  However as it converts a grey
scale image into just pure back and white colors we will need to extract an
alpha channel mask from the image, dither that, and return it back into the
image.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png \( +clone -fx a +matte -monochrome \) \
          -compose CopyOpacity -magick composite   a_dither.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
   <A HREF="a_dither.gif"
      ><IMG SRC="a_dither.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

In a similar way, there are a couple of other dither operators which can be
limited to just the alpha channel using the "<CODE><A
HREF="../option_link.cgi?channel" >-channel</A></CODE>" setting (unlike
"<CODE><A HREF="../option_link.cgi?monochrome" >-monochrome</A></CODE>").

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png -channel A -ordered-dither   o2x2   a_ordered_2x2.gif
  magick a.png -channel A -ordered-dither   o3x3   a_ordered_3x3.gif
  magick a.png -channel A -ordered-dither   o4x4   a_ordered_4x4.gif

  magick a.png -channel A -ordered-dither  checks  a_halftone_2.gif
  magick a.png -channel A -ordered-dither  h4x4a   a_halftone_4.gif
  magick a.png -channel A -ordered-dither  h6x6a   a_halftone_6.gif
  magick a.png -channel A -ordered-dither  h8x8a   a_halftone_8.gif

<r>  magick a.png -channel A -random-threshold  5x95% a_random_5x95.gif
<r>  magick a.png -channel A -random-threshold  5x70% a_random_5x60.gif
<r>  magick a.png -channel A -random-threshold 50x95% a_random_50x95.gif
<r>  magick a.png -channel A -random-threshold 45x55% a_random_45x55.gif
  magick a.png -channel A -random-threshold 50x50% a_random_50x50.gif
</CODE></PRE></TD></TR></TABLE>

   <A HREF="a_ordered_2x2.gif"
      ><IMG SRC="a_ordered_2x2.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_ordered_3x3.gif"
      ><IMG SRC="a_ordered_3x3.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_ordered_4x4.gif"
      ><IMG SRC="a_ordered_4x4.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
<BR>
   <A HREF="a_halftone_2.gif"
      ><IMG SRC="a_halftone_2.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_halftone_4.gif"
      ><IMG SRC="a_halftone_4.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_halftone_6.gif"
      ><IMG SRC="a_halftone_6.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_halftone_8.gif"
      ><IMG SRC="a_halftone_8.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
<BR>
   <A HREF="a_random_5x95.gif"
      ><IMG SRC="a_random_5x95.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_random_5x60.gif"
      ><IMG SRC="a_random_5x60.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_random_50x95.gif"
      ><IMG SRC="a_random_50x95.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_random_45x55.gif"
      ><IMG SRC="a_random_45x55.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_random_50x50.gif"
      ><IMG SRC="a_random_50x50.gif"       WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=0 ALT="[IM Output]"></A>
</DIV></P>

As you can see "<CODE><A HREF="../option_link.cgi?ordered-dither"
>-ordered-dither</A></CODE>" produces a pattern of transparent and opaque
colors to represent the overall transparency.  This however produces a very
noticeable regular pattern. However if you use a shadow color that is similar
too but darker than the normal background then you can make this pattern
almost completely invisible. </P>

The '<CODE>checks</CODE>' pattern (first image on second line) is of
particular interest as it is a very simple 3 level pattern that is very clean,
and neat.  </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28
    ><IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    The "<CODE><A HREF="../option_link.cgi?ordered-dither"
    >-ordered-dither</A></CODE>" was extended in IM v6.2.8-6 with 'half-tone'
    dither patterns.  The operator was then completely revised for IM v6.3.0
    with named dither patterns (use "<CODE><A HREF="../option_link.cgi?list"
    >-list</A> threshold</CODE>" to see the full list). You can even generate
    your own dithering pattern to generate other special effects. See <A
    HREF="../quantize/#ordered-dither" >Ordered Dithering Examples</A> and the
    <A HREF="../bugs/ordered-dither/" >Ordered Dither Upgrade notes</A> for
    more details. </P>

    Before this redevelopment, arguments could only consist of the geometry
    strings '<CODE>2x2</CODE>', '<CODE>3x3</CODE>' and '<CODE>4x4</CODE>'
    (which will still work).  However, anything else was then treated as being
    a "<CODE><A HREF="../option_link.cgi?random-threshold"
    >-random-threshold</A></CODE>" argument, usually with disastrous results.
    Caution is required when using this option on very old versions of IM.

</I></FONT></TD></TR></TABLE></P>


The "<CODE><A HREF="../option_link.cgi?random-threshold"
>-random-threshold</A></CODE>" on the other hand produces a highly variable
randomized dither that is different each time it is run.  The purely random
nature of the this dither algorithm however tends to produce large 'clumps' of
pixels, rather than the smoother, algorithmic placed dithering generated by
the "Floyd-Steinberg" "<CODE><A HREF="../option_link.cgi?monochrome"
>-monochrome</A></CODE>" operator. </P>

The big advantage of "<CODE><A HREF="../option_link.cgi?random-threshold"
>-random-threshold</A></CODE>" however is the limit controls it provides.  By
making the parameters very restrictive (for example as '50x50%') you would
magick <CODE><A HREF="../option_link.cgi?random-threshold"
>-random-threshold</A></CODE>" into a simple "<CODE><A
HREF="../option_link.cgi?threshold" >-threshold</A></CODE>" operator.  By
being only a little less restrictive you can randomize just the very edge of
the threshold limit, (for example using '45x55%'). </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/reminder.gif" WIDTH=20 HEIGHT=16
    ><IMG SRC="../img_www/space.gif"   WIDTH=20 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    The "<CODE><A HREF="../option_link.cgi?random-threshold"
    >-random-threshold</A></CODE>"  argument '<CODE>PxQ</CODE>', where
    <CODE>P</CODE> is the min threshold and <CODE>Q</CODE> is the max (the '%'
    symbol is required).  So "5x95%" says anything below is 5% of
    <CODE>MaxRGB</CODE> is set to 0, anything above 95% is set to
    <CODE>MaxRGB</CODE> otherwise we choose a random value between 5% and 95%
    of MaxRGB, as the threshold level to use for that pixel.  an argument of
    "5x95%" value is probably the best value to use in most situations.

</I></FONT></TD></TR></TABLE></P>

You can improve the final look by using a darker mid-tone color (like a dark
grey) instead of black for the shadow color. By doing this the color will tend
to blur into the background more making the dither less pronounced that what
is shown above. </P>

If you do know approximately what the background color is, you can even
use a darker color of that shade to make the shadow bend in better without
restricting yourself to the specific background shade.  Sort of mix the two
methods a little to improve the overall result. </P>

Basically The more work you put into what you want to do, the better the
result will be. </P>

<PRE>
FUTURE: dither example with a dither color matching the light blue background
of this web page.
</PRE>

<A NAME="gif_non-im">
<H3>Non-ImageMagick GIF Processing</H3>
</A>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5>
<TR valign="top"><TD>
    <A HREF="http://www.ict.griffith.edu.au/anthony/software/#giftrans"
    >giftrans</A>
<TD>Lists all the attributes and color table of GIF image.  It can also set a
    specific color index as the transparent color without modifying the images
    color table ordering, or merging color indexes holding the same color (not
    a recommended situation). </P>

    The IM "<CODE>identify</CODE>" command I have found to do a better job
    of listing image attributes, including the 'loop repeat limit' in the
    "Mosaic Application Extension" used in image animations. </P>

    See also the "<CODE>gif2anim</CODE>" script (below), which previously
    used this program to extract the GIF image meta-data needed to re-create
    the GIF from the individual 'frames' extracted.  It now only uses
    "<CODE>identify</CODE>", to extract this meta-data. </P>

<TR valign="top"><TD>
    <A HREF="http://www.lcdf.org/gifsicle/"
    >GIFsicle</A>
<TD>This is a general-purpose image optimizer program, whose original purpose
    was to re-add compression to GIF images at a time when that algorithm was
    still under copyright. </P>

    The program can also be used to add comments, create GIF animations and
    also optimise such animations in the same way that the IM "<CODE><A
    HREF="../option_link.cgi?deconstruct" >-deconstruct</A></CODE>" operator
    does, though with further transparency optimizations such as <A
    HREF="../anim_opt/#opt_lzw" >LZW Compression Optimization</A>. </P>

<TR valign="top"><TD>
    <A HREF="http://utter.chaos.org.uk/~pdh/software/intergif.htm"
    >InterGIF</A>
<TD>A similar program to GIFsicle, designed for processing animated GIFs.
    However it only provides <A HREF="../anim_opt/#opt_trans" >Transparency
    Compression Optimization</A>.  Other features however may be useful
    however. <I>Mail me your views.</I> </P>

<TR valign="top"><TD>
    <A HREF="../scripts/gif2anim"
    >gif2anim</A>
<TD>A shell script which takes a GIF animation file, and extracts all the
    individual frame images, as well as a "<CODE>.anim</CODE>" file containing
    all the IM "<CODE>convert</CODE> settings needed to rebuild the animation
    from the extracted frame images. </P>

<TR valign="top"><TD>
    <A HREF="../scripts/anim2gif"
    >anim2gif</A>
<TD>The reverse of the above script, which takes a "<CODE>.anim</CODE>" file
    containing all the IM "<CODE>convert</CODE> settings and rebuilding a GIF
    animation image. </P>

    This script is very useful for studying, editing, adjusting and merging
    GIF animation files.  For basic usage see <A
    HREF="../anim_basics/#list_info" >Animation List Information</A>.  Also
    see <A HREF="../anim_mods/#append" >Appending Animations (time synced)</A>
    for a practical example of its use. </P>

</TABLE></P>

<A NAME="gif_offsets"></A>
<H3>GIF Image Offset handling</H3>

While the GIF format saves images with offsets as part of its image animation
handling, it will not save a negative offset.  Any attempt to save a negative
offset to a GIF image will result in the offset being reset to zero.   This
can be a real pain when designing GIF image animations. </P>

If Internet Explorer web browser is given an GIF image whose 'page offset'
places the image somewhere outside the 'page canvas size', it will ignore the
page size and offset and magick display it as if it has no such offset. </P>

The ancient Mozilla web browser on the other hand will just magick display the image
canvas, and apply the offsets to the image. This can result in an empty canvas
being magick display with no image data present, which while correct, can be
unexpected. </P>

Both will magick display the image using the page canvas size, with the appropriate
page offset if the image is wholly contained on that page canvas. </P>

<A NAME="gif87"></A>
<H3>Related GIF Output formats</H3>

<DL>
<DT>GIF87: Output the image in the older GIF 87a  format. </P>

<DD>If the "Mozilla" web browser sees this older format it will completely
    ignore the page geometry of the image, and will not use a larger 'page'
    frame, or use image offsets with the image. </P>

    IM version 6.0.4 and earlier would normally produce a GIF89a format.  But
    if the image was a GIF animation, and was split up into separate images
    using +adjoin, Im would use the GIF87a, resulting in inconsistent results
    when displayed in web browsers. </P>

    IM after v6.0.4 will always produce a GIF 89a image format file, unless
    the user specifically asks for the older "<CODE>GIF87:</CODE>" output
    format. </P>

</DL>

<HR><!-- ---------------------------------------------------------------- -->

<A NAME="jpg"></A>
<H2>JPEG Image File Format</H2>

This format is about as common as the <A HREF="#gif" >GIF format</A> above.
But where GIF is designed with small simple "cartoon-like" images in mind,
JPEG is designed for large real life images with lots of different colors, and
shades of colors, such as photographs.  </P>

A key feature of the JPEG file format is its compression, which reduces image
size while keeping the image acceptable to the human eye.  This is a very
complex process and beyond the scope of this discussion. For more information
about this process and its effects see  <A
HREF="http://www.photo.net/learn/jpeg/" >Jpeg Compression Introduction</A>.
And a great nitty-gritty explaination in the You Tube Video <A
HREF="https://www.youtube.com/watch?v=Q2aEzeMDHMA" >JPEG DCT, Discrete Cosine
Transform (JPEG Pt2)- Computerphile</A> </P>

Unfortunately, to compress images well, the algorithm intentionally
<I>loses</I> information.  What is saved is <B>NOT</B> the same image as what
is in memory; the color of a particular pixel or area of an image will
generally will NOT be exactly the same color that was saved.  This is
particularly true near the edges of objects within the image.  </P>

So as a quick word of warning...
<DIV ALIGN=center><B>
      IM is a general raster image processor, for modifying images.
<BR>       It will not do lossless JPEG modifications.
</B></DIV>
If you are interesting in lossless handling, see <A HREF="#jpg_non-im">Non-IM
JPEG Handling</A>. </P>

<BR>

This lossy behaviour becomes even more noticable if a JPEG image is changed
so that the amount of change to the top or left boundary is not
a multiple of 8.  When this happens the JPEG compression 'blocks' or 'cells'
will be completely different, and that can produce a large increase in the
final image save size.  </P>

That is operations such as chop, trim, shave, border, frame, extent, etc..
(See <A HREF="../crop/" >Cutting and Bordering Operations</A> that can shift
the image data by a pixel offset that is not a 8. </P>

See the IM Forum discussion <A HREF="../forum_link.cgi?f=1&t=20415&p=81480"
>Cropping an image result in an unexpected increased file</A> for more
details. </P>


<BR>

Normally this <I>lossy</I> nature of JPEG data is not very noticeable.
However it can become noticeable when you either load and save a JPEG image
multiple times or use a very low quality with a diagram showing sharp color
changes.  </P>

However as long as you don't load or re-use JPEG images over and over
(preserve and apply operations from the original source), it is still a good
file format even image types it is not particularly good at handling.  </P>

As an example of this lossy JPEG nature, here I generate a simple image of two
gradients appended together.  While the gradients provide a smooth color
change that JPEG handles very well, the sharp color change between the two
gradients are not handled well.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick -size 5x10  gradient: gradient:blue-navy  +append jpg_lossy.gif
  magick jpg_lossy.gif                  jpg_lossy.jpg
</CODE></PRE></TD></TR></TABLE>
  <A HREF="jpg_lossy.gif"
     ><IMG SRC="jpg_lossy_mag.gif"    WIDTH=100 HEIGHT=100
           ALIGN=middle VSPACE=5 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
<IMG SRC="../img_www/right.gif" ALIGN=middle WIDTH=20 HEIGHT=20 ALT="==>">
  <A HREF="jpg_lossy.jpg"
     ><IMG SRC="jpg_lossy_tn.gif"    WIDTH=100 HEIGHT=100
           ALIGN=middle VSPACE=5 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

The first image is a magnified view of the undistorted GIF format version of
the image (click the image to see or downlaod the un-magnified view).  It only
contains 20 colors, so in this case the GIF format can handle the image
perfectly and actually generate a very small file size (see table below). On
the other hand the JPEG version of the image shows clear color distortions
that the JPEG compression added to the saved image, to allow it to compress it
better. </P>

The distortions are greatest in the blue color channel, which is not
surprising as blue is not resolved well by the human eye. That is the human
eye tends to 'spread out' blue colors naturally, so the JPEG algorithm takes
advantage of this (by internally using a YCbCr colorspace).   In fact without
the magnification used above, you would be hard pressed to see the effect. </P>

Lets have a look at the effect of quality on the image.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick jpg_lossy.gif   -quality 100%  jpg_lossy_100.jpg
  magick jpg_lossy.gif   -quality  80%  jpg_lossy_80.jpg
  magick jpg_lossy.gif   -quality  50%  jpg_lossy_50.jpg
  magick jpg_lossy.gif   -quality  20%  jpg_lossy_20.jpg
  magick jpg_lossy.gif   -quality   5%  jpg_lossy_5.jpg
</CODE></PRE></TD></TR></TABLE>
  <A HREF="jpg_lossy.gif"
     ><IMG SRC="jpg_lossy_mag.gif"    WIDTH=100 HEIGHT=100
           ALIGN=middle VSPACE=5 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
<IMG SRC="../img_www/right.gif" ALIGN=middle WIDTH=20 HEIGHT=20 ALT="==>">
  <A HREF="jpg_lossy_100.jpg"
     ><IMG SRC="jpg_lossy_100_tn.gif"    WIDTH=100 HEIGHT=100
           ALIGN=middle VSPACE=5 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
  <A HREF="jpg_lossy_80.jpg"
     ><IMG SRC="jpg_lossy_80_tn.gif"    WIDTH=100 HEIGHT=100
           ALIGN=middle VSPACE=5 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
  <A HREF="jpg_lossy_50.jpg"
     ><IMG SRC="jpg_lossy_50_tn.gif"    WIDTH=100 HEIGHT=100
           ALIGN=middle VSPACE=5 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
  <A HREF="jpg_lossy_20.jpg"
     ><IMG SRC="jpg_lossy_20_tn.gif"    WIDTH=100 HEIGHT=100
           ALIGN=middle VSPACE=5 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
  <A HREF="jpg_lossy_5.jpg"
     ><IMG SRC="jpg_lossy_5_tn.gif"    WIDTH=100 HEIGHT=100
           ALIGN=middle VSPACE=5 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

If you look closely at first image result in the above, which we saved the
test image at '<CODE>100%</CODE>' or maximum quality, there is still some
slight color distortion.  It is very hard to see, but it is present. </P>

On the other hand using a progressively lower "<CODE><A
HREF="../option_link.cgi?quality" >-quality</A></CODE>" setting for the JPEG
image makes this color distortion even larger and more noticable. Not only
that it sets up a sort of 'shadowing' of the edges producing 'waves' of color
changes spreading out from the sharp edges. An effect commonly known as <A
HREF="../filter/#ringing" >Ringing Artefacts</A>.  </P>

However the reason for using compression is that the size of the resulting
image is very dramatically smaller, at least initially.  Here is a file list
of the results and their size in bytes. </P>

<!-- <CODE EXECUTE NOIMAGE OUT=jpg_ls_lossy.txt>
  ls -lS --time-style=+ jpg_lossy*.jpg | awk '{ print $5, $6 }'
  magick jpg_lossy.gif -scale 100x100 'jpg_lossy_mag.gif'
  magick jpg_lossy*.jpg -scale 100x100 \
          -set filename:fname '%t_tn' +adjoin '%[filename:fname].gif'
</CODE> -->

<DIV ALIGN=center>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="jpg_ls_lossy.txt"
     ><IMG SRC="jpg_ls_lossy.txt.gif"
           ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>

Note that the GIF image in this case is very small, as large 'blocks' of color
compresses extremely well in GIF.  As the JPEG quality gets lower, the size of
the image also gets smaller.  The default quality setting, when no JPEG
quality is set, either by the user, or from the source image format file, is
about 92%, which is a very high quality. </P>

However using a lower quality setting than '<CODE>50%</CODE>', image sizes do
not get much smaller in terms of file size savings, only a much more
progressively degraded image. It is a process of diminishing returns. </P>

In summary...
<DIV ALIGN=center><B>
           JPEG losses information, degrading images when saved.
<BR>   Use some other format for intermediate images during processing.
<BR> Only use JPEG format, for the final image, not for further processing.
</B></DIV></P>

JPEG is also not good for artificial images with sharp color changes, such as
line drawings, diagrams, or cartoon-like icons, text, and symbols. Such images
with a low number of colors are better saved using a palette image format,
such as GIF, or PNG8. </P>

A new JPEG image format, Jpeg2000, is becoming available which does allow
lossless JPEG compression.  However this requires the 'JasPer' library to also
be installed.  To use this special format, you also need to use
a "<CODE>-compress jpeg2000</CODE>" option or save to a JP2 file format, so IM
will call the right library. </P>


<A NAME="jpg_trans"></A>
<H3>JPEG transparency - NOT </H3>

Other than compression, the other major problem that JPEG users faces is that

<DIV ALIGN=center><B>
                   JPEG does not save transparency
</B></DIV></P>

Thus while you can overlay images onto a background color or pattern and save
to JPEG, you cannot give a JPEG image a free-form border or with see-through
holes. </P>

As JPEG was designed to save real world images, and not parts of images, as
such transparency was not an issue it was concerned about, when the format was
created.  Consequently the designers never worried about including an alpha
channel, or other transparency information in the file format. </P>

For example let take the PNG with transparency we used above and magick it
directly to JPEG.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png  a.jpg
</CODE></PRE></TD></TR></TABLE>
   <A HREF="a.png"
      ><IMG SRC="a.png"
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=1 ALT="[IM Output]"></A>
<IMG SRC="../img_www/right.gif" ALIGN=middle WIDTH=20 HEIGHT=20 ALT="==>">
   <A HREF="a.jpg"
      ><IMG SRC="a.jpg"
            ALIGN=middle VSPACE=5 HSPACE=15 BORDER=1 ALT="[IM Output]"></A>
</DIV></P>

As you can see all transparent parts just became black. But depending on the
image source (especially GIF images) the transparent areas could have just as
easily become some other random, or other inappropriate color. </P>

If this could be a problem the best idea is to have IM
<A HREF="../masking/#remove" >Remove Alpha Transparency</A>, before
saving the image to the JPEG image file format. </P>

<A NAME="jpg_color"></A>
<H3>JPEG Color Distortion (testing)</H3>

As mentioned above, the compression algorithm JPEG used is lossy.  That image
will be modified to allow it to compress better, reducing file space,
hopefully. </P>

Exactly how much color distortion occurs depends on the quality settings
use.  For example let us look at how many colors are in the IM built-in
"<CODE>netscape:</CODE>" image...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD WIDTH=10%></TD><TD WIDTH=70% VALIGN=middle>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE OUT=jpg_colors_none.txt>
  magick identify -format "Colors: %k" netscape:
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <TABLE BORDER=0 width="100%" HEIGHT=100% BGCOLOR="#CCCCCC"><TR><TD>
    <A HREF="jpg_colors_none.txt"
       ><IMG SRC="jpg_colors_none.txt.gif"
             ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
  </TD></TR></TABLE>
</TD></TR></TABLE>
As you can see this image by default has 216 colors in a large rectangular
array.  This type of image is NOT a very good image for saving to JPEG format,
which makes it ideal for our purposes. </P>

So lets look at the number of colors a JPEG image save of this image
produces...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD WIDTH=10%></TD><TD WIDTH=70% VALIGN=middle>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE OUT=jpg_colors_def.txt>
  magick netscape: JPG:- |\
     magick identify -format "Colors: %k\nFile Size: %b" -
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <TABLE BORDER=0 width="100%" HEIGHT=100% BGCOLOR="#CCCCCC"><TR><TD>
    <A HREF="jpg_colors_def.txt"
       ><IMG SRC="jpg_colors_def.txt.gif"
             ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
  </TD></TR></TABLE>
</TD></TR></TABLE>

That is, by default, the saved JPEG file has almost 9 times as many colors!
Though the result would still look like the original image, the edges of the
rectangular area will have had colors added to nearby. </P>

Saving at the highest quality setting will <I>not</I> save the image without
any color distortion...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD WIDTH=10%></TD><TD WIDTH=70% VALIGN=middle>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE OUT=jpg_colors_100.txt>
  magick netscape: -quality 100 JPG:- |\
     magick identify -format "Colors: %k\nFile Size: %b" -
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <TABLE BORDER=0 width="100%" HEIGHT=100% BGCOLOR="#CCCCCC"><TR><TD>
    <A HREF="jpg_colors_100.txt"
       ><IMG SRC="jpg_colors_100.txt.gif"
             ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
  </TD></TR></TABLE>
</TD></TR></TABLE></P>

As you can see a very high quality setting will only add a few extra colors
but the image will still have a slight (minimal) color distorted.  You can
also see that the filesize is larger, as very little compression can be
achieved. </P>

Now let us try "Lossless"...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD WIDTH=10%></TD><TD WIDTH=70% VALIGN=middle>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE OUT=jpg_colors_lless.txt>
  magick netscape: -quality 100 -compress Lossless JPG:- |\
     magick identify -format "Colors: %k\nFile Size: %b" -
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <TABLE BORDER=0 width="100%" HEIGHT=100% BGCOLOR="#CCCCCC"><TR><TD>
    <A HREF="jpg_colors_lless.txt"
       ><IMG SRC="jpg_colors_lless.txt.gif"
             ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
  </TD></TR></TABLE>
</TD></TR></TABLE></P>

Still a color distortion!  Obviously my JPEG library is NOT patched for
lossless encoding.  However remember only another patched library can read
such a lossless JPG image. </P>

Alternatively I recommend compiling your IM to use the JasPer library and the
newer JP2 image file format.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD WIDTH=10%></TD><TD WIDTH=70% VALIGN=middle>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE OUT=jp2_colors_lless.txt>
  magick netscape: JP2:- |\
     magick identify -format "Colors: %k\nFile Size: %b" -
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <TABLE BORDER=0 width="100%" HEIGHT=100% BGCOLOR="#CCCCCC"><TR><TD>
    <A HREF="jp2_colors_lless.txt"
       ><IMG SRC="jp2_colors_lless.txt.gif"
             ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
  </TD></TR></TABLE>
</TD></TR></TABLE></P>

As you can see the Jpeg2000 format switched to other non-lossy methods of
image compression, but does not color distort the image, by default.  It also
performs some very high compression methods on the image. </P>

However using a lower quality with the new JP2 format will again introduce the
color distortions, so as to generate a smaller image, just like the normal
JPEG image file format...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR valign="top"><TD WIDTH=10%></TD><TD WIDTH=70% VALIGN=middle>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE OUT=jp2_colors_50.txt>
  magick netscape: -quality 50% JP2:- |\
     magick identify -format "Colors: %k\nFile Size: %b" -
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <TABLE BORDER=0 width="100%" HEIGHT=100% BGCOLOR="#CCCCCC"><TR><TD>
    <A HREF="jp2_colors_50.txt"
       ><IMG SRC="jp2_colors_50.txt.gif"
             ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
  </TD></TR></TABLE>
</TD></TR></TABLE></P>

For more information of using the JPEG2000 coder, see <A
HREF="https://imagemagick.org/script/jp2.php" >JPEG2000 encoding parameter
documentation</A>. </P>


<A NAME="jpg_read"></A>
<H3>Reading JPEG Control Options</H3>

<BLOCKQUOTE><DL>
<DT><A HREF="../option_link.cgi?define"
    >-define</A> jpeg:size={width}x{height}
<DD>This setting is a hint to the JPEG image library to read just enough of
    the input (JPEG) image file to create an image that is at least the given
    size (width &times; height) or larger. </P>

    If the input image is huge, this can greatly reduce the amount of memory
    IM needs for the image read, since IM will then be handling a smaller
    image. This, in turn, can dramatically increase the speed of the complete
    operation. </P>

    Remember this is only a hint as the size of the image wanted, you are not
    guaranteed to get this size, just something close-to but larger than that
    size. Typically you will get something that is between this size and one
    twice that big, while preserving the images aspect ratio. </P>

    Usually after reading a JPEG image with a size hint, the image is then
    immediately resized to its final 'exact' size.   Typically using "<CODE><A
    HREF="../option_link.cgi?thumbnail">-thumbnail</A></CODE>" to strip any
    image profiles, as well.  </P>

    For example...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
    magick -define jpeg:size=64x64   jpeg_large.jpg jpeg_size_hint.jpg
    magick -define jpeg:size=128x128 jpeg_large.jpg \
                                   -thumbnail 64x64  jpeg_thumbnail.jpg
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28
    ><IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    Before IM v6.5.6-0  this coder setting was extracted from the "<CODE><A
    HREF="../option_link.cgi?size" >-size</A></CODE>" setting.  This caused
    problems when users used "<CODE><A HREF="../option_link.cgi?size"
    >-size</A></CODE>" for image creation but then had JPEG reading produce
    unexpected results. As such this was changed to be a special coder setting
    instead. </P>

    On older versions you may need to reset the "<CODE><A
    HREF="../option_link.cgi?size" >-size</A></CODE>" setting using "<CODE><A
    HREF="../option_link.cgi?size" >+size</A></CODE> before reading JPEG
    images, or IM may not real a JPEG image in full. </P>

</I></FONT></TD></TR></TABLE></P>

    Note that this modifier causes the JPEG library to skip the reading of
    whole columns and rows of pixels. As such it will produce effects much
    like the <A HREF="../resize/#sample" >Sampling Resize Operator</A>,
    including its strong <A HREF="../filter/#aliasing" >Aliasing
    Artefacts</A>. </P>

    Because of this is it recommended that you specify at least double the
    final 'resize' of the image, to avoid this problem, just as shown in the
    above example. </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/reminder.gif" WIDTH=20 HEIGHT=16
    ><IMG SRC="../img_www/space.gif"   WIDTH=20 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    Note that the <A HREF="../resize/#thumbnail" >Thumbnail Resize
    Operator</A> also uses the same sampling technique for extrememly
    large-scale resizing operations to quickly reduce the size of the image
    before using a normal resize operation, though to 5 times rather than
    double the final image size.  The difference in size is a matter of final
    image quality.
</I></FONT></TD></TR></TABLE></P>


<DT><A HREF="../option_link.cgi?profile"
    >+profile</A> '*'
<DT><A HREF="../option_link.cgi?strip"
    >-strip</A>
<DD>JPEG images as saved by digital cameras, scanning software and other
    image processing software like "photoshop" will often add large profiles
    of "<I>program comments</I>" to JPEG images.  Either of these options
    will remove those profiles from an image, after that image read in. </P>

    The "<CODE><A HREF="../option_link.cgi?profile" >+profile</A></CODE>"
    operator will remove all color profiles from an image, while "<CODE><A
    HREF="../option_link.cgi?strip" >-strip</A></CODE>" will remove all
    profiles and meta-data that the image may have. </P>

    Also note that "<CODE><A HREF="../option_link.cgi?thumbnail"
    >-thumbnail</A></CODE>" is a "<CODE><A HREF="../option_link.cgi?resize"
    >-resize</A></CODE>" option that will also so a "<CODE><A
    HREF="../option_link.cgi?strip" >-strip</A></CODE>" at the same time.  See
    also <A HREF="../thumbnails/" >Creating Thumbnails</A>. </P>

<DT><A HREF="../option_link.cgi?type"
    >-type</A> TrueColorMatte
<DD>As JPEG does not save any form of transparency, when it is read in it will
    always be fully-opaque, and have not 'alpha' or 'matte' channel in memory.
    This setting will force any JPEG image read in after the option to have a
    fully-opaque 'matte' channel to be added to the image in memory.  </P>

    The better way to do this however is to use a "<CODE><A
    HREF="../option_link.cgi?matte" >-matte</A></CODE>" or "<CODE><A
    HREF="../option_link.cgi?matte" >-alpha</A> set</CODE>", after reading the
    image, as it will have less impact on the reading and writing of other
    image formats. </P>

    See <A HREF="../basics/#type" >Image Type when Reading and Writing</A> and
    <A HREF="../masking/#alpha_set" >Alpha Set</A> for more information. </P>

</DL></BLOCKQUOTE>


<A NAME="jpg_write"></A>
<H3>Writing JPEG Control Options</H3>

By default the "<CODE><A HREF="../option_link.cgi?quality"
>-quality</A></CODE>" and "<CODE><A HREF="../option_link.cgi?sampling-factor"
>-sampling-factor</A></CODE>" that was found when reading the JPEG image is
used when writing back to a JPEG image.  This however may not produce the same
file size on the disk, and you will still always have a further loss of image
quality due to reading and re-saving an JPEG image. </P>

The JPEG quantization tables are not however preserved. </P>

<BLOCKQUOTE><DL>
<DT><A HREF="../option_link.cgi?quality"
    >-quality</A> {percent}
<DD>Probably the more important option when saving JPEG images, as this
    controls just how much the image is compressed when save it to disk.
    The value is not a size percentage, just a quality value.  The lower the
    value the smaller the image and the more image information is lost,
    producing more artifacts, and degrading the image. <P>

    <PRE>    FUTURE: VERY low quality example of a photo</PRE> </P>

    NOTE: a quality setting of '<CODE>100%</CODE>' is not guaranteed to save
    an image without any loss of quality, just a minimal amount of loss.  (See
    the next option) </P>

    NOTE: You cannot determine a quality to get a specific file size, except
    through trial-and-error. Start with a "<CODE><A
    HREF="../option_link.cgi?quality" >-quality</A></CODE>" of 75% and check
    the resulting file size. If it is too large, reduce the quality by 10%; if
    too small, increase. After you have a lower and upper bound on quality, do
    a binary search to find a quality that best matches your desired file
    size. A total of five or six trials should be sufficient. </P>

<DT><A HREF="../option_link.cgi?define"
    >-define</A> jpeg:extent={size}
<DD>As of IM v6.5.8-2 you can specify a maximum output filesize for the
    JPEG image.  The size is specified with a suffix.  For example
    "<CODE>400kb</CODE>". </P>

    It works by generating many versions of the JPEG image, doing a binary
    search, of the output quality "<CODE><A HREF="../option_link.cgi?quality"
    >-quality</A></CODE>" setting, until it gets as close as possible to the
    file size given without exceeding it.  It does this by writing the image
    repeatably into a temporary file and once it has the appropriate quality
    size, it then outputs the final image to the given output filename, once.
    </P>

    The output will thus still work fine when outputting the final image to
    a pipeline, or direct to network, and not just to a real file. However do
    not expect this process to be very fast due to I/O requirements. Perhaps
    4 to 8 times slower. </P>

    Mail me your results if you actually do a timing comparison. </P>

<DT><A HREF="../option_link.cgi?compress"
    >-compress</A> LossLess
<DD>While a "<CODE><A HREF="../option_link.cgi?quality" >-quality</A></CODE>"
    setting of '<CODE>100%</CODE>' can still produce slightly different colors
    (it is still 'lossy'), the "<CODE>-compress LossLess</CODE>" option will
    ask the JPEG library to save the image without any loss of data.  As such
    re-reading the image will restore should be exactly as it was saved. </P>

    WARNING: This will only work if your JPEG library has been patched for
    'LossLess JPEG' encoding, but the use of the JP2 file format has replaced
    this so this option rarely has any real effect anymore. </P>

    Also you <I>MUST</I> also set "<CODE>-quality 100%</CODE>" for this to
    work. </P>

    While intuitively you would think that saving with '<CODE>LossLess</CODE>'
    will automatically mean using a 100% quality, this is not the case.  This
    is the result of tacking on an unusual patch for the JPEG image writing,
    which is a lossy format by definition.  </P>

    Of course the file generated will probably much be larger than a normal
    JPEG image.  Also you will end up with a lossless compressed JPEG which
    you won't be able to read anywhere except with a similarly 'patched' JPEG
    library.  </P>

    As such 'lossless JPEG' is <I>NOT recommended</I> and some other format
    (like PNG or JP2) should be used instead. </P>

<DT><A HREF="../option_link.cgi?interlace"
    >-interlace</A> Line
<DD>Use a 'Progressive JPEG' style that allows you to see large jpeg images
    while it is still being loaded. Also see the non-IM solution for
    re-encoding an existing JPEG without further loss, below. </P>

<DT><A HREF="../option_link.cgi?sampling-factor"
    >-sampling-factor</A> {<I>horizontal</I>}x{<I>vertical</I>}
<DD>Adjust the sampling factor used by JPEG library for chroma down sampling.
    This can be set to '<CODE>2x1</CODE>' for creating MPEG-2 animation files.
    </P>

    "2x2, 1x1, 1x1" is IM's standard sub-sampling method and corresponds to
    4:2:0, see <A HREF="http://en.wikipedia.org/wiki/Chroma_subsampling"
    >Wikipedia, Chroma Sub-Sampling</A>. However when "quality" is 90 or
    higher, the channels are not sub-sampled.  Basically it will define whether
    the processing 'block' or 'cell' size is 8 pixels or 16 pixels. </P>

<DT><A HREF="../option_link.cgi?density"
    >-density</A> {<I>Xdpi</I>}x{<I>Ydpi</I>}
<DD>While density has no effect on the output pixel size of the the resulting
    image.  The above setting however is stored in the JFIF header of the JPEG
    image file format.  Unfortunately some programs like Photoshop will ignore
    this setting if a density is also present in a special photoshop specific
    profile ('<CODE>8BIM</CODE>') stored in the image.  </P>

    Density is really only important when an output device is being used, such
    as printers or monitors, allowing these devices to magick display the image
    scaled to real world sizes.  For example ensuring the photo or page you
    scanned is printed at the right size.  For more information about density
    see and <A HREF="../basics/#density" >Image Density Meta-data</A> and <A
    HREF="../resize/#resample" >Resample Resizing</A>. </P>

<DT><A HREF="../option_link.cgi?type"
    >-type</A> TrueColor
<DD>IM will automatically use a gray-scale internal format for images that
    only contain gray-scale values.  This  setting will override this
    behaviour and force IM to always produce a color JPEG image rather than
    gray-scale. </P>

    See <A HREF="../basics/#type" >Image Type when Reading and Writing</A> for
    more information. </P>

<!-- Does not do anything, settings are always preserved if posible.
<DT><A HREF="../option_link.cgi?define"
    >-define</A> jpeg:preserve-settings
<DD>
-->

<DT><A HREF="../option_link.cgi?define"
    >-define</A> jpeg:optimize-coding=false
<DD>Turn off the calculation of optimal Huffman coding tables for this image.
    This is on by default. It does require an extra pass over the image,
    to do the calculations needed, but this is minimal.  </p>

<DT><A HREF="../option_link.cgi?define"
    >-define</A> jpeg:q-table={path}
<DD>Defines a file containing custom JPEG quantization tables, in XML.
    An example table is typically installed in
    "<CODE>/etc/ImageMagick/quantization-table.xml</CODE>" but is built-in
    to ImageMagick and thus not normally used. </P>

    A number of discussions about generating tables are to be found in the <A
    HREF="../forum_link.cgi?f=22" >Digital Image Processing Forum</A>, with
    specific discussions (at time or writing) at
    <A HREF="../forum_link.cgi?t=20414" >JPEG Quantization Tables</A>,
    <A HREF="../forum_link.cgi?t=20333" >Better JPEG quantization tables?</A>,
    <A HREF="../forum_link.cgi?t=20402" >Stupid PET Trick qtable of one</A>,
    <A HREF="../forum_link.cgi?t=20427" >JPEG luma quantization table</A>. </P>

    This option was added to IM v6.5.7-8. </P>

</DL></BLOCKQUOTE>


<A NAME="jpg_size"></A>
<H3>JPEG Quality vs File Size</H3>

The final file size of a JPEG file for a given quality is indeterminate. The
whole process of compression is so complex with small changes producing wildly
different changes to the compression. Its a 'butterfly-effect'.  </P>

Even the same source picture with the same quality, but with different
versions of IM, JPEG library, or other image processing programs, you will get
very wide differences in file size, and observed quality.  You may as well
treat the quality setting as simple 'guess' as to how much compression or
visual quality should be applied to a specific image. </P>

In essence it is a practical impossibility to pre-determine the final file
size for a given image and quality setting... Except by actually doing it. </P>

IM however can do 'test runs' to discover the best quality to use for
a specific file size by using the special '<CODE>jpeg:extent</CODE>' define.
See <A HREF="#jpg_write" >JPEG Write Controls</A> above. It is extremely
slow, but faster than a similar DIY solution. </P>

Doing this is not recommended, and not just because it is slow. </P>

By your fixed file size method, a simple image might come out at quality
90%, but contain 50k of unnecessary data, where as a complicated image would
have to drop to quality 30% and be exhibiting JPEG artifacts (or to put it
less technically, it would look rubbish) due to a shortage of data for the
detail present. </P>

The better idea is to find a single quality setting that produces an average
file size of 100KB for a reasonable selection of your images.  Even then
images with not much detail in may come out at only 50k. While images with
lots of intricate detail may come out at 150k, both will look acceptable.
</P>

For a practical guide to the JPEG compression and quality, see
<A HREF="http://www.ampsoft.net/webdesign-l/jpeg-compression.html"
>Optimization of JPEG compression settings</A>. </P>

Also see <A HREF="http://www.impulseadventure.com/photo/jpeg-compression.html"
>JPEG Compression, Quality and File Size</A> for a look at the JPEG internal
details. </P>

<B>Photoshop Tip</B>: Photoshop will add about 4 Kbytes of extra information
to JPEG images to hold previews and color management info (profile
'<CODE>8BIM</CODE>').  If you do not want that information, use the 'Save for
Web' function.  This tip was found in a paper on JPEG compression by <A
HREF="http://www.fho-emden.de/~hoffmann/howww41a.html" >Gernot Hoffmann</A>.
</P>

<BR>

<A NAME="jpg_formats"></A>
<H3>Related JPEG Output Formats</H3>

<DL>
<DT>PJEG: Write a Progressive load JPEG Image.
<DD>This is not often used in these days of fast network downloads, but was
    very common when dial-up modems were the norm. Basically write every
    N lines first, then a line between them, and so on, so you can see an
    image even after only down downloading a small percentage of the complete
    image.  </P>

<DT>JPEG2000: The latest JPEG format with new additions.
<DD>This format requires the 'JasPer jp2' library to be installed or you get a
    error..

    <DIV ALIGN=center>
          "<CODE>no encode delegate for this image format</CODE>"
    </DIV> </P>

    This format uses wavelet compression to compress images instead of the
    standard JPEG DCT method. This gives you much better compression ratios
    for the same image quality.  Thus reducing disk space even more. </P>

    Unfortunately it hasn't been widely adopted yet, so you can't use it for
    external purposes, at least until web browsers and other image viewers and
    editors also start making use of the format. </P>

    Any images saved with this format are only readable by users with this
    library, and it will probably be a long time before a good percentage of
    uses use this library.  Particularly windows users as Microsoft will
    probably not include it unless enough people demand it. </P>

    <B>Quicktime Tip</B>: Quicktime uses jp2 format but it must be output at
    "<CODE><A HREF="../option_link.cgi?depth" >-depth</A> 8</CODE>".
</DL></P>

<A NAME="jpg_non-im"></A>
<H3>Non-ImageMagick JPEG Processing
<FONT SIZE=-1>(A quick summary)</FONT></H3>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5>
<TR valign="top"><TD>
    <!A HREF=""
    >jpegtran</A>
<TD>Standard tool that is installed with the JPEG library.  This allows you to
    apply various transforms to JPEG format images without decoding and
    re-encoding the image data, thus avoiding the JPEG data to become
    degraded. (see below) </P>

<TR valign="top"><TD>
    <A HREF="http://www.jpegclub.org/"
    >jpegtrans</A>
<TD>A newer version of the previous "<CODE>jpegtran</CODE>" program, though
    many of the added features (such as lossless cropping) has now been built
    into the distributed library version (above). </P>

<TR valign="top"><TD>
    <A HREF="http://www.sentex.net/~mwandel/jhead/"
    >jhead</A>
<TD>A more user-friendly lossless JPEG handler, especially with regards to the
    EXIF digital camera profile.  That the handling of comments, date
    adjustments, thumbnail extraction, deletion or replacement, profile
    stripping, etc.  It also attempts to ensure that other profiles are not
    trashed, which is something that "<CODE>jpegtran</CODE>" tends to do. </P>

    There are also other similar programs such as "<CODE><A
    HREF="http://www.sno.phy.queensu.ca/~phil/exiftool/"
    >ExifTool</A></CODE>", and "<CODE><A
    HREF="http://www.exifer.friedemann.info/" >Exifer</A></CODE>". Many JPEG
    to web photo-album programs also does this.  </P>

</TABLE></P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90%><TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28
    ><IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
  The JPEG lossless rotation (which all the above provide) will only work
  correctly for images that have a size that is divisible by 8 or 16. This is
  true with most (but not all) digital camera photos.  If you try this with an
  image that is an odd size the right or bottom edge blocks (containing the
  partial size) will not be positioned correctly in the final image, as these
  block can only exist on the right or bottom edge. </P>

  For an example of this see this <A HREF="../forum_link.cgi?t=16784&p=62157"
  >specific discussion</A>
</I></FONT></TD></TR></TABLE></P>


As you can see most of these programs are designed to process JPEG image
meta-data without re-processing the JPEG compressed image. (see next) </P>


<A NAME="jpg_lossless"></A>
<H3>Lossless JPEG Processing</H3>

As decoding and re-encoding a JPEG image results in a degrading of image
quality (unless lossless compression is used) the JPEG image library provides
a number of special programs that can manipulate the image, without loss of
quality. </P>

These commands will also be generally a lot faster than IM equivalents, as they
do not have to do as much processing of the image. </P>

When modifying comments in JPEG images You can use the lower level JPEG
library programs "<CODE>rdjpgcom</CODE>", "<CODE>wrjpgcom</CODE>" and
"<CODE>jpegtran</CODE>".   However I recommend you use  "<CODE><A
HREF="http://www.sentex.net/~mwandel/jhead/" >jhead</A></CODE>" program, as it
preserves any profile or other information that is also present in the image.
</P>

The "<CODE>jpegtran</CODE>" allows you to go further and actually losslessly
manipulate image data, including 90 degree rotation, cropping, and drop-in.
It Even allows the creation of mixed quality JPEG images.  For a demonstartion
of this see <A HREF="http://wiki.thorx.net/wiki/JPEGhack" >JPEGhack</A> page
by Nemo Thorx. (See the notes below) </P>

However these commands are <I>NOT</I> recommended for general use, as they are
limited to the block boundaries (8 or 16 bit) of the JPEG image. That is to
say  That is you can only crop, rotate, or drop-in at a JPEG compression cell
level, not at the actual pixel level.</P>

<B>Comments</B>... </P>

If you are creating <A HREF="../montage/#html" >Montage Thumbnail Web Index
Pages</A> of your JPEG photos, and like to use the comments you add to the
JPEG files, using the above programs, use a "<CODE>-label '%c'</CODE>" to tell
magick montage to use the 'comment' field, before reading filename on the
"<CODE>montage</CODE>" command line. </P>

You can also use that comment in a <A HREF="../transform/#polaroid" >Complex
Polaroid Transformation</A>, or a <A HREF="../montage/#polaroid" >Polaroid
Montage</A> or some type of image <A HREF="../text/#annotate"
>Annotation</A>. </P>

The "<CODE><A HREF="http://www.sentex.net/~mwandel/jhead/" >jhead</A></CODE>"
program be used to add or modify comments in JPEG image files.  However I
found using the "edit comments" ("<CODE>-ce</CODE>") option to not a good way
to do that as it adds an extra newline to the end of the comment.  This extra
newline stuffs up the use of commands ('<CODE>%c</CODE>' label formatting
escape) in IM. </P>

The better way is to use "comment input" ("<CODE>-ci</CODE>") to feeding in a
comment (without newlines at the end), or the "comment literal"
("<CODE>-cl</CODE>") options to be a much better way...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  jhead -cl 'Photo of some stuff, by Joe Citizen'  image_of_stuff.jpg
</CODE></PRE></TD></TR></TABLE>
</DIV></P>


<B>Thumbnails</B>... </P>

Brian Jackson &lt;brian&#64;brianjacksonphoto.com&gt; also reports that most
digital cameras (such as his is a Cannon 1D) embed a thumbnail somewhere between
12kb-25kb in size (160x120 pixels), in the JPEG image they produce. </P>

IM can extract these thumbnails using...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
   magick image.jpg   thumbnail:thumb.jpg
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

However the program "<CODE><A HREF="http://www.sentex.net/~mwandel/jhead/"
>jhead</A></CODE>" can also extract these thumbnails too...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  mkdir thumbs
  jhead -st "thumbs/&amp;i" *jpg
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

This is super fast compared to IM as it does not edit the image, just transfer
existing data. However the quality of the thumbnail is not nearly as good, as
thumbnails IM can generate from the real image, and they also may not be
rotated right, and they definitely will not be the size you want.  </P>

<B>Using ExifTool</B>... </P>

From Rob,

If you want more detailed editing of the profiles stored in JPEG image files,
than what "<CODE><A HREF="http://www.sentex.net/~mwandel/jhead/"
>jhead</A></CODE>" provides, have a look at more EXIF-centric applications of
the perl based, "<CODE><A
HREF="http://www.sno.phy.queensu.ca/~phil/exiftool/" >ExifTool</A></CODE>", an
alternative compiled version "<CODE><A
HREF="http://www.dalibor.cz/minolta/exiftool.htm" >ExifTool</A></CODE>", and a
Windows GUI  "<CODE><A HREF="http://www.exifer.friedemann.info/"
>Exifer</A></CODE>", just to name a few. </P>

With the Image::ExifTool Perl module installed, this will strip out all JPEG
metadata loslessly.  I found the following to be equivalent to the command
line method for stripping EXIF data.  In case anyone is interested in the
future: </P>

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  use Image::ExifTool;
  $exifTool = new  Image::ExifTool;
  $exifTool->SetNewValue('*');  # delete  all...
  $exifTool->WriteInfo('original_image.jpg','modified_image.jpg');
  $errorMessage = $exifTool->GetValue('Error');
  print  $errorMessage;  # (if has value an error occurred)
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

Took some figuring because it turns out you needed to assign the setting first
using SetNewValue then load and save simultaneously using WriteInfo. </P>


<B>Mixed JPEG Quality Images, using JpegTrans</B>... </P>

Wolfgang Hugemann <Auto@Hugemann.de> wanted the edges of a JPEG image to not
be compressed at all, as it stuffs up photo handling. See <A
HREF="http://www.photopla.net/wwp0703/stripes.php" >this site</A>.  The
solution provided by Yuval Levy &lt;imagemagick07_AT_sfina.com&gt;
solution was to use "<CODE>jpegtran</CODE>" to insert a low quality JPG, into
a high quality JPEG... </P>

<UL>The solution:
<LI> produce two versions of the same image with ImageMagick, one at
  the high quality 100 and the other at low quality 60 (for size reduction).
<LI> use jpegtran to crop the q60, shaving off 8 pixels on each side
<LI> use jpegtran to merge the q60 on top of the q100
<LI> use jpegtran to merge to a stripe
</UL>

Nemo Thorx &lt;jpeghack&#64;nemo.house.cx&gt;, read the above and tried to
implement Mixed JPEG quality.  He succeeded and demonstrates the results on
his Wiki pages at <A HREF="http://wiki.thorx.net/wiki/JPEGhack" >JPEGhack</A>.
Basically it is very posible to do lossless JPEG, processing such as
'cropping' and 'dropping' new sections of JPEG blocks into an existing image.
</P>


<HR><!-- ---------------------------------------------------------------- -->

<A NAME="png"></A>
<H2>PNG Image File Format</H2>

This is one of the newest and most modern image formats, supporting 32 bit
colors including alpha channel transparency, but can also be optimised to a
GIF like 8 bit index color scheme (256 color limit). </P>

As such it makes an excellent intermediate format for image processing
without loss of image information. </P>

<A NAME="png_quality"></A>
<H3>PNG compression</H3>

When used with PNG output, quality is regarded as <B>two decimal figures</B>.
The first digit (tens) is the zlib compression level, 1-9. However if
a setting of '<CODE>0</CODE>' is used you will get Huffman compression rather
than 'zlib' compression, which is often better!  Weird but true! </P>

The second digit is the PNG data encoding filtering (before it is comressed)
type: 0 is none, 1 is "sub", 2 is "up", 3 is "average", 4 is "Paeth", and 5 is
"adaptive". So for images with solid sequences of color a "none" filter
(<CODE>-quality 00</CODE>) is typically better.   For images of natural
landscapes an "adaptive" filtering (<CODE>-quality 05</CODE>) is generally
better. </P>


<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28
    ><IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
  The PNG coder has been undergoing lots of work, and better methods of
  controlling the exact encoding and compression settings is typically
  set using the <A HREF="../basics/#define" >Define Operator</A>. </P>

  See <A HREF="#png_write" >Writing PNG Image Controls</A> below for more
  details of the defines, or loot at the comments in the PNG coder file,
  "<CODE>coder/png.c</CODE> source code. </P>

</I></FONT></TD></TR></TABLE></P>

If you have an ImageMagick image with binary (on/off) transparency, the PNG
encoder will write it in an efficient manner, using the tRNS chunk instead of
a full alpha channel. But if any opacity value other than 0 or MaxRGB is
present, it'll write a PNG with an alpha channel.  You can force this behavior
by using the "<CODE>-type TruecolorMatte</CODE>" image reading setting, or you
can save the image using the "<CODE>PNG32:</CODE>" format file. </P>

An external program "<CODE><A HREF="http://pmt.sourceforge.net/pngcrush/"
>pngcrush</A></CODE>" or the newer version "<CODE><A
HREF="http://optipng.sourceforge.net/" >OptiPNG</A></CODE>" will attempt to
re-compress a specific PNG for the best possible compression available, and is
recommended for images that you plan to place on a web site. Another program
"<CODE><A HREF="http://www.cybertherial.com/pngnq/pngnq.html"
>pngnq</A></CODE>" will color quantize it to a 256 color, 8bit PNG, though it
is not known if this support semi-transparent colors in that format. </P>

<A NAME="png_compress"></A>
<H3>Better PNG Compression</H3>

One point about PNG images is that PNG image will preserve the color of
fully-transparent pixels. That is even though you can not see it transparency
has color, and PNG preserves that data. </P>

This means that in many cases PNG can be made to compress better by replacing
that 'invisible color' with a static solid color, rather than garbage color
that may be left over from previous image processing. </P>

There are two major methods you can use for this, using <A
HREF="../masking/#alpha_background" >Alpha Background Operator</A> to just
handle fully-transparent pixels only,  or using a <A
HREF="../color_basics/#fuzz_alpha" >Fuzz Factor with Transparency</A> type
operation to also map near-semi-transparent colors to fully-transparent-black.
</P>

For example here I take the fuzzy shadowed "<CODE>a.png</CODE>" image we
generated above and replace all pixels that are within 20% of full
transparency.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png  -fuzz 10% -transparent none  a_compress.png
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
    <A HREF="a_compress.txt"
      ><IMG SRC="a_compress.txt.gif"
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE>
   <A HREF="a.png"
      ><IMG SRC="a.png"        WIDTH=70  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_compress.png"
      ><IMG SRC="a_compress.png"   WIDTH=70  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</DIV></P>
<!-- <CODE EXECUTE NOIMAGE OUT=a_compress.txt>
  ls -l a.png a_compress.png | awk '{printf "%6s %s\n", $5, $NF}' -
</CODE> -->

As you can see you get a substantial improvement in image size (around 50%).
But with a sharp cut-off for the shadow of the image. </P>

Another alternative is to just make the shadow effect smaller, by adjusting
transparency channel <A HREF="../color_mods/#level" >Levels</A>.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png  -channel A -level 20,100%,0.85 +channel \
          -background black -alpha background a_compress2.png
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
    <A HREF="a_compress2.txt"
      ><IMG SRC="a_compress2.txt.gif"
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE>
   <A HREF="a.png"
      ><IMG SRC="a.png"        WIDTH=70  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
   <A HREF="a_compress.png"
      ><IMG SRC="a_compress2.png"   WIDTH=70  HEIGHT=60
            ALIGN=middle VSPACE=2 HSPACE=0 BORDER=0 ALT="[IM Output]"></A>
</DIV></P>
<!-- <CODE EXECUTE NOIMAGE OUT=a_compress2.txt>
  ls -l a.png a_compress2.png | awk '{printf "%6s %s\n", $5, $NF}' -
</CODE> -->

You can also improve the compression algorithm results, and thus the final
size of your PNG image by using a smaller number of colors.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick image.jpg -thumbnail 200x90 -colors 256 \
          -quality 90 -depth 8  thumbnail.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

This however is only recommended for small thumbnail images that do not
involve transparency, and only as a final step as it is a very 'lossy'
technique.  </P>


<A NAME="png_www"></A>
<H3>PNG, Web Browsers and Transparency</H3>

The Microsoft Internet Explorer (IE version 6 and earlier) does not correctly
magick display PNG when any sort of transparency is involved.  Now while this is the
most well known browser not to fully support PNG, it isn't the only one.  The
<A HREF="http://trific.ath.cx/web/png/" >PNG transparency test</A> and <A
HREF="http://entropymine.com/jason/testbed/pngtrans/" >Another PNG test</A>
pages will let you test your browser. They also list the browsers and versions
that produce the results displayed. </P>

However as IE (at least at time of writing) is probably the most common
browser, you can add to your web page a number of work-arounds to the problem.
For information on this look at my WWW Laboratory Page <A
HREF="http://www.ict.griffith.edu.au/anthony/wwwlab/pngtest/" >PNG with
Transparency and IE</A>, where I test and demonstrate the the "PNG in IE"
solution I am using.  </P>

Other solutions are to magick the PNG to either JPEG (with the right colored
background), or GIF formats.  These methods are discussed thoroughly for <A
HREF="#bgnd" >GIF Images on Backgrounds</A>. </P>

Another solution is to set the color of all fully-transparent colors in a
image before saving it to PNG.  PNG will save that fully-transparent color,
but be warned that just about any other IM operation will reset
fully-transparent back to fully-transparent black (as transparent color is not
suppose to matter at that is the way image mathematics work). </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR VALIGN=bottom><TD width="100%" ALIGN=justify>

For example the standard <A HREF="../#PNG" >IM examples test image</A> uses
full transparent black for any pixel that is fully-transparent.  We can verify
this by either turning off the alpha channel, or saving it a JPEG...

<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick test.png test.jpg
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <A HREF="test.jpg"
     ><IMG SRC="test.jpg"         WIDTH=150  HEIGHT=100
           ALIGN=middle VSPACE=0 HSPACE=2 BORDER=1 ALT="[IM Text]"></A>
</TD></TR></TABLE></P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR VALIGN=bottom><TD width="100%" ALIGN=justify>

Now lets save this so that all the fully transparent colors was replace with
fully-transparent '<CODE>silver</CODE>' color (see the <A
HREF="../masking/#alpha_background" >Alpha Background</A> operator)...

<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick test.png   -background silver -alpha Background   test_silver.png
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <A HREF="test_silver.png"
     ><IMG SRC="test_silver.png"         WIDTH=150  HEIGHT=100
           ALIGN=middle VSPACE=0 HSPACE=2 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE></P>

Note that the image should still look correct if transparency (or the special
JAVA script on the page) is working on your browser. </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR VALIGN=bottom><TD width="100%" ALIGN=justify>

But if we turn off the alpha channel (by saving to JPEG that does not allow
alpha) we can see that the PNG image really does use a 'silver' color for the
fully-transparent pixels.

<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick test_silver.png test_silver.jpg
</CODE></PRE></TD></TR></TABLE></TD><TD WIDTH=20% HEIGHT=100%>
  <A HREF="test_silver.jpg"
     ><IMG SRC="test_silver.jpg"         WIDTH=150  HEIGHT=100
           ALIGN=middle VSPACE=0 HSPACE=2 BORDER=1 ALT="[IM Text]"></A>
</TD></TR></TABLE></P>

Note however that this does NOT modify semi-transparent pixels, and these will
still have their normal (non-transparent) colors without mixing that color
with either the page background, or the color used for fully-transparency.
</P>

As semi-transparency is no longer involved, borders can look jagged (aliased),
as well as 'halo' effects, along lighter colored edges.  For example look at
the edges of the black and white circles which show the 'jaggies' aliasing
effects. However using a gray replacement color should make this not as bad as
as the original 'black' color used for full transparency.  </P>

The other advantage of setting the color of fully-transparent pixels, is
an improvment in compression of data.  Sometimes, the underlying colors in
transparent areas used during processing were preserved. These in turn do not
compress as well as a solid color.  As such setting the fully-transparent
color as we did above, can produce a good saving in the final file size.  </P>

However this should be done as a final step as many IM image processing
operations will replace any fully-transparent color that is present in an
image back into fully-transparent black. See the <A
HREF="../masking/#alpha_background" >Alpha Background</A> operator for a list
of operators known to do this. </P>

My preference is for PNG magick display problems, is for Microsoft to fix IE, and it
seems that IE version 7 will finally have a fully working PNG transparency
handling, in all situations. </P>


<A NAME="png_offsets"></A>
<H3>PNG and the Virtual Canvas</H3>

While normally PNG will NOT save virtual canvas size information,  it does
save virtual canvas offset information, and if present, IM will try to
generate a 'canvas size' that is appropriate for  that offset and image size.

This can be important to remember for some image operators such as  "<CODE><A
HREF="../option_link.cgi?crop" >-crop</A></CODE>", "<CODE><A
HREF="../option_link.cgi?trim" >-trim</A></CODE>" and "<CODE><A
HREF="../option_link.cgi?flatten" >-flatten</A></CODE>", etc., which make use
of the images canvas or page size as part of its operation or results. </P>

Of course you can use the "<CODE><A HREF="../option_link.cgi?page"
>-page</A></CODE>" setting and "<CODE><A HREF="../option_link.cgi?repage"
>-repage</A></CODE>" operator, to set or remove the virtual canvas size and
offset. (See <A HREF="../basics/#page" >Page Image Attribute</A>).

For example, the second IM "<CODE>convert</CODE>" sees the offset that is
present in this PNG image, and defines a canvas that is large enough to ensure
the image is visible within the virtual canvas bounds (Added to IM v6.1.7)...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick rose: -repage 0x0+40+30 png:- |\
      magick - -background LightBlue -flatten  png_offset_flattened.jpg
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
  <A HREF="png_offset_flattened.jpg"
     ><IMG SRC="png_offset_flattened.jpg"
           ALIGN=middle VSPACE=0 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

However, even though the PNG format will not normally save canvas size
information, IM does add some virtual canvas size meta-data to PNG images.
This data however will only be usable by IM commands, and is generally ignored
by other PNG image format readers. </P>

For example the second "<CODE>convert</CODE>" command does see some virtual
canvas size information...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick rose: -repage 100x100+10+10 png:- |\
      magick - -background LightBlue -flatten  png_size_flattened.jpg
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
  <A HREF="png_size_flattened.jpg"
     ><IMG SRC="png_size_flattened.jpg"
           ALIGN=middle VSPACE=0 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

If the PNG is processed by some non-IM program this canvas size meta-data will
probably be lost. Remember canvas size information is not normally part of the
PNG image file format. </P>

The other thing to note is that the 'offset' information can have a negative
offset (unlike the GIF format), and IM will handle these appropriately, making
the format good for storing intermediate <A HREF="../layers/" >Layer
Images</A>. </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/reminder.gif" WIDTH=20 HEIGHT=16
    ><IMG SRC="../img_www/space.gif"   WIDTH=20 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
  Some web browsers do not handle negative offsets very well, producing odd
  results (one version of firefox had this problem).  Best to avoid a negative
  offset in images that may be used by other programs like web browsers.
</I></FONT></TD></TR></TABLE></P>


<A NAME="png_density"></A>
<H3>PNG Resolution, Density and Units</H3>

After some testing it seems the PNG image file format does not support a
"<CODE><A HREF="../option_link.cgi?units" >-units</A></CODE>" setting of
'<CODE>PixelsPerInch</CODE>', only '<CODE>undefined</CODE>' and
'<CODE>PixelsPerCentimeter</CODE>'.  </P>

Because of this IM converts a given density/unit setting into the appropriate
values for '<CODE>PixelsPerCentimeter</CODE>'. </P>

<I>More to come on this subject</I>. </P>


<A NAME="png_formats"></A>
<H3>PNG Sub-Formats</H3>

<TABLE>
<TR><TD>PNG:   <TD>Default. Save image using economical format.
<TR><TD>PNG8:  <TD>The PNG equivalent to GIF, including Boolean transparency
                   and a 256 color table.
<TR><TD>PNG24: <TD>8 bit RGB channels without an alpha channel.
                   Special case can include boolean transparency (see below)
<TR><TD>PNG32: <TD>Force a full RGBA image format with full semi-transparency.
<TR><TD>PNG48: <TD>16 bit RGB channels without alpha channel
<TR><TD>PNG64: <TD>16 bit RGBA image (including semi-transparency)
<TR><TD>PNG00: <TD>Inherit PNG color and bit depth from input image.
</TABLE></P>

For more information see <A HREF="../basics/#type" >Image Type I/O
Setting</A>. </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/reminder.gif" WIDTH=20 HEIGHT=16
    ><IMG SRC="../img_www/space.gif"   WIDTH=20 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    PNG8 was defined by PhotoShop, not the PNG group.  And while it can handle
    multiple semi-transparent colors, as well as a fully-transparent color,
    IM assumes that it doesn't.  This provides a way to force images to work
    properly with default be readable by Internet Explorer v6.  The
    "<CODE>Photoshop CS</CODE>" program can read it.
</I></FONT></TD></TR></TABLE></P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28
    ><IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    The PNG48, PNG64 and PNG00 styles were added as of  IM v6.8.2-0
</I></FONT></TD></TR></TABLE></P>

You can force IM to create an image color index table (or palette) then IM will
save that image using a "<CODE>PNG8:</CODE>" format...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick {input_image}  -type Palette  indexed.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

To force the use of an single 8 bit greyscale channel, but not a palette
indexed image use...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick {input_image}  -type GrayScale -depth 8  gray.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

You can (added IM v6.3.5-9) also output greyscale with a transparency channel.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick {input_image}  -type GrayscaleMatte  gray_with_transparency.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

And for a simple two color image...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick {input_image}  -type BiLevel  bitmap.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

A special case exists for PNG24 images.  If the image only contains boolean
transparency, and all thge transparent colors are the same and that color is
only used for transpareny, then the PNG coder will specify that specific color
as being transparent.  For example...

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  magick a.png -channel A -threshold 75% +channel \
          -background hotpink  -alpha background png24:a_png24_alpha.png
</CODE></PRE></TD></TR></TABLE></TD><TD>
   <A HREF="a_png24_alpha.png"
      ><IMG SRC="a_png24_alpha.png"    WIDTH=70 HEIGHT=60
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

This image does not have a pallette, but does have some on/off alpha. </P>

The <A HREF="../option_link.cgi?threshold" >-threshold</A> of the alpha
channel ensures only boolean (on/off) transparency is present, while the <A
HREF="../masking/#alpha_background" >Alpha Background</A> option ensures all
fully transparent pixels is a specific color.  The above does NOT ensure there
is no opaque pixel with that color, so the above can still fail. </P>



<A NAME="png_write"></A>
<H3>Writing PNG Image Controls</H3>

To better control the writing of PNG images, Glenn Randers-Pehrson revised
a number of coder "<CODE><A HREF="../basics/#define" >Define
Global Setting</A></CODE>" controls, for IM v6.5.2. These include...

<DL>
<DT><A HREF="../option_link.cgi?quality"
    >-quality</A> '{level}{filter}'
<DD>The basic compression level and filter when saving a PNG image. </P>

<DT><A HREF="../option_link.cgi?define"
    >-define</A> png:compression-strategy=<I>zs</I><BR>
    <A HREF="../option_link.cgi?define"
    >-define</A> png:compression-level=<I>zl</I><BR>
    <A HREF="../option_link.cgi?define"
    >-define</A> png:compression-filter=<I>fm</I><BR>
<DD>Completely define the compression system to be used for the PNG image
    being written. The <A HREF="../option_link.cgi?quality" >-quality</A>
    setting will normally set the <I>zl</I> and <I>fm</I> values, but not the
    <I>zs</I> setting. </P>

<DT><A HREF="../option_link.cgi?depth"
    >-depth</A> {depth}
<DD>The general depth of the image to be generated, typically set to 8 or 16
    bit. </P>

<DT><A HREF="../option_link.cgi?define"
    >-define</A> png:bit-depth={depth}
<DD>Precisely specify the depth of the resulting PNG image file format.
    This overrides the normal IM "<CODE><A HREF="../option_link.cgi?depth"
    >-depth</A></CODE>" control, but only for writing PNG images, and only
    when the change can be made without loss.  In the case of color-mapped
    images, this is the depth of the color-map indices, not of the color
    samples. </P>

<DT><A HREF="../option_link.cgi?define"
    >-define</A> png:color-type={type}
<DD>Precisely specify the type of the PNG file being written. Values can be
    either
    <TABLE BORDER=1>
    <TR><TD>'<CODE>0</CODE>'
        <TD> for Greyscale, which allows for '<CODE>bit-depths</CODE>'
             of 2, 3, 4, 8 or 16.
    <TR><TD>'<CODE>2</CODE>'
        <TD> for RGB, which allows for '<CODE>bit-depths</CODE>' of 8 or 16.
    <TR><TD>'<CODE>3</CODE>'
        <TD> for Indexed, which allows for '<CODE>bit-depths</CODE>'
             of 1, 2, 4 or 8.
    <TR><TD>'<CODE>4</CODE>'
        <TD> for Gray-Matte
    <TR><TD>'<CODE>6</CODE>'
        <TD> for RGB-Matte
    </TABLE></P>

    Note that "<CODE>-define png:color-type='2'</CODE>" is specifically useful
    to force the image data to be stored as RGB values rather than sRGB
    values. However a similar effect can be achieved using "<CODE>-set
    colorspace sRGB</CODE>" on a linear RGB image.  Howvever, do not expact
    that programs will honor this linear colorspace when reading.  This
    includes ImageMagick.</P>


<DT><A HREF="../option_link.cgi?profile"
    >-profile</A> PNG-chunk-{x}:{file}
<DD>Add a raw PNG profile at location {x} from {file}.  The first 4 bytes of
    {file} contains the chunk name, followed by a colon ':' character, and
    then the chunk data. </P>

    The {x} can be 'b' to place profile before the PLTE, 'm' between the PLTE
    and IDAT,  or a 'e' for after the IDAT.  If you want to write multiple
    chunks of the same type, then add a short unique string after the {x} to
    prevent subsequent profiles from overwriting the preceding ones . </P>

    For example..
<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  -profile PNG-chunk-b01:file01 -profile PNG-chunk-b02:file02
</CODE></PRE></TD></TR></TABLE>
</DIV></P>


<DT><A HREF="../option_link.cgi?set" >+set</A> date:create<BR>
    <A HREF="../option_link.cgi?set" >+set</A> date:modify<BR>
<DD>These are image 'properities' which are created by ImageMagick whenever
    it reads a file.  They contain (respectively) the image files create time
    (actually permission/owner/move change time) and last file modification
    time. </P>

    Unfortunatally PNG image file formats like to write such image data with
    the PNG image file format, and if this data is different, then the file
    generated will also be different, even if nothing else has changed. </P>

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE> magick logo: logo.jpg magick logo.jpg
    logo1.png

  sleep 2; touch logo.jpg      # change the JPG file timestamp
  magick logo.jpg logo2.png

  diff -s logo1.png logo2.png
  magick compare -metric RMSE logo1.png logo2.png null:
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

    The "<CODE>diff</CODE>' in the above will return the message
    <DIV ALIGN=center>
       "<CODE>Binary files logo1.png and logo2.png differ</CODE>"
    </DIV>
    Even though the "<CODE>compare</CODE>" returned "<CODE>0 (0)</CODE>"
    which says the images have exactly the same image data. </P>

    Note that as IM overwrites these properities with the
    times of the PNG file it just read, you can't see the actual values
    of these properities recorded in the PNG using "<CODE>identify</CODE>".
    </P>

    The solution is to save PNG images without any 'time stamps'.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick logo: logo.jpg
  magick logo.jpg +set date:create +set date:modify logo1.png

  sleep 2; touch logo.jpg
  magick logo.jpg +set date:create +set date:modify logo2.png

  diff -s logo1.png logo2.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

    This time "<CODE>diff</CODE>" reported...
    <DIV ALIGN=center>
       "<CODE>Files logo1.png and logo2.png are identical</CODE>"
    </DIV></P>

    ASIDE: you can also use other UNIX programs such as "<CODE>cmp</CODE>",
    "<CODE>md5sum</CODE>", or "<CODE>sha1sum</CODE>" to magick compare binary image
    files. The latter two programs is not guranteed, but they are practically
    impossible to fool, and are faster for comparing more than two files
    (using the checksum) </P>

    Thanks to some additions by GlennRP, the PNG developer you can now also
    use  "<CODE>-define png:exclude-chunk=date</CODE>" to tell
    the PNG coder not to write date-related text chunks.

</DL></P>

<A NAME="png_non-im"></A>
<H3>Non-ImageMagick PNG Processing</H3>

There are quite a number of helper applications for PNG, that could be useful
adjuncts for generating a final PNG image file. </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5>
<TR valign="top"><TD>
    <!A HREF=""
    >pngtrans</A>
<TD>PNG information stored with an image </P>

<TR valign="top"><TD>
    <A HREF="http://pmt.sourceforge.net/pngcrush/"
    >pngcrush</A>
<TD>Tries to find the best compression of a PNG by attempting to compress the
    image using all logical PNG compression available, before making a final
    choice, for each individual image.  This of course can take some time on
    each image. </P>

<TR valign="top"><TD>
    <A HREF="http://optipng.sourceforge.net/"
    >OptiPNG</A>
<TD>A newer PNG compression optimizer. </P>

<TR valign="top"><TD>
    <A HREF="http://www.libpng.org/pub/png/apps/pngquant.html"
    >pngquant</A>
<TD>Lossy PNG optimizer, reducing a PNG image down to an 8 bit color palette
    with dithering.  It will build indexed-color PNG's with alpha transparency
    colors conveyed in the tRNS chunk. </P>

<TR valign="top"><TD>
    <A HREF="http://www.cybertherial.com/pngnq/pngnq.html"
    >pngnq</A>
<TD>A newer lossy PNG quantizer, to generate 8 bit color table PNG images. Also
    forces the use of a color palette.</P>

<TR valign="top"><TD>
    <A HREF="http://www.advsys.net/ken/utils.htm"
    >pngout</A>
<TD>A Windows platform PNG optimizer (with optional GUI) that uses a
    ZIP compressor that is optimized for space rather than speed (also on the
    page linked above).
</TABLE></P>

Most of these are to improve the final size of the image file, either using
a lossy OR non-lossy techniques. </P>

<HR><!- ---------------------------------------------------------------- ->

<A NAME="profiles"></A>
<H2>Image Profiles</H2>

Handling profiles photo quality images is important, However from what I can
tell this is a very magical art, and not simple matter. </P>

Not all formats use profiles, but most modern formats do.  This includes
JPEG, PNG, TIFF, and (as of IM v6.3.4-1) GIF. </P>

If fact the problem is exacerbated by the fact that many programs do not even
understand or look for color profiles in images.  <A
HREF="http://www.snibgo.org/contact.htm" >Alan Gibson, aka Snibgo</A>, put
together a summary of how various web browsers handle various Color Profiles,
on his own <A HREF="http://www.snibgo.org/improf.htm" >Snibgo, ImageMagick
Profiles</A> page.  This is worth a look. </P>


To list what profiles are present in an image use...
<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick identify -verbose image.tif | grep 'Profile-.*bytes'
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

Common Profiles (and pointer to info I have on them) include...
<DL><DD><TABLE>
<TR valign="top"><TH>EXIF</TH><TD>
   <A HREF="../photos/#exif" >Digital Camera Meta-Data</A></TD></TR>
<TR valign="top"><TH>ICC</TH><TD>
   <A HREF="#color_profile" >Image Color Space Profile</A></TD></TR>
<TR valign="top"><TH>ICM</TH><TD>
   <A HREF="#color_profile" >Microsoft Color Management (like ICC)</A></TD></TR>
<TR valign="top"><TH>IPTC</TH><TD>
   <A HREF="#profile_iptc" >Image and Author Info</A></TD></TR>
<TR valign="top"><TH>8BIM</TH><TD>Photoshop Meta-data profile.
   Including data on: Clip Paths... <I>What else?</I></TD></TR>
<TR valign="top"><TH>XMP</TH><TD>Adobe's Extensible Metadata Platform (XMP)
 (See <A HREF="http://www.adobe.com/products/xmp/" >adobe page</A>)</TD></TR>
</TABLE></DD></DL>

You can extract these common profiles using some special output formats that
IM provides for this purpose. For example...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick -define jpeg:size=64x64  image.jpg  iptc:profile.iptc
  magick -define jpeg:size=64x64  image.jpg  xmp:profile.xmp
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

The "<CODE><A HREF="../option_link.cgi?define" >-define</A></CODE>" option in
the above is used as a 'hint' to the JPEG library to reduce the amount of
actual image data it reads into memory and then save a lot of processing of
the data you don't actually intend to use. </P>

You can also insert or re-insert an arbitrary profile as a 'blob' or binary
string containing whatever information you like.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  -profile '<I>profile_name</I>:<I>data_file</I>'
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

That is the file "<CODE>data_file</CODE>" is added 'as is' to the image as the
profile <I>profile_name</I>.  IM or any other application will ignore such
profiles, unless it specifically knows about it.  </P>


<A NAME="color_profile"></A>
<H4>Color Profile Basics</H4>

First a quick word...
<DIV ALIGN=center><B>
   <A HREF="http://tinyurl.com/yr9mkt"
     >Color Management is for Wimps</A> -- Don't Play with them
<BR>   Messing with profiles generally makes things worse
</B></DIV>

So if the colors look good... Leave it alone. </P>

An user <I>fhoech</I> in the IM Forums, (who has since disappeared) has quite
a number of times posted the following basic introduction in using color
profiles to change the color space used by images... </P>

The RGB, sRGB and CMYK are not colorspaces, they are color systems (which IM
controls using the "<CODE><A HREF="../option_link.cgi?colorspace"
>-colorspace</A></CODE>" operator).  There is no single RGB or CMYK
colorspace, but a literally infinite amount of different colorspaces are
possible in each color system. </P>

You need ICC (or ICM) profiles which accurately characterize the colors in
your images.  Normally, the ICC profile that describes an image should be
embedded in the image itself, otherwise, you have to use a 'best guess'
attempt which is only a workaround: Open the image in an ICC-capable image
editor and assign different ICC profiles (do not convert!) until you find one
that looks OK with your image (your monitor must be calibrated so you actually
get a good preview of the colors).  Then, save the image with the profile
embedded. </P>

As to why you need two profiles: The source profile describes the colors in
your image as they are now. The destination profile describes the colors in the
output image after conversion. </P>

Also, you should take great care when converting to a given destination
profile: If, for example, you use a profile that describes offset printing on
uncoated stock but intend to use the images for printing on coated paper, you
will of course not get any good results. The output profile needs to be an
accurate representation of your intended output condition. </P>

When converting from a subtractive into an additive color-space (or visa-versa)
without using the correct profile (for both steps of conversion) you won't get
'correct' colors or brightness in most cases, although you may be lucky and hit
the mark 'by accident'. </P>

You can download color profiles from  <A
HREF="http://www.color.org/srgbprofiles.xalter" >International Color
Consortium</A>. </P>


<A NAME="color_profile_changing"></A>
<H3>Changing Colorspace via Profiles</H3>

While you can just simple magick color spaces directly like this...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick <I>cmyk_image.jpg</I> -colorspace rgb <I>rgb_image.jpg</I>
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

The best solution for converting CMYK to RGB JPEG is to use color profiles
with the "<CODE><A HREF="../option_link.cgi?profile" >-profile</A></CODE>"
operator. </P>

<I>Raf Lenaerts</I> pointed out the following rules in using the "<CODE><A
HREF="../option_link.cgi?profile" >-profile</A></CODE>" operator within
ImageMagick...
<DL>
<DD>If there is no embedded profile then the first "<CODE><A
    HREF="../option_link.cgi?profile" >-profile</A></CODE>" is the input
    profile.  A second "<CODE><A HREF="../option_link.cgi?profile"
    >-profile</A></CODE>" then defines the output profile. </P>
<DD>If there is an embedded profile then a single of "<CODE><A
    HREF="../option_link.cgi?profile" >-profile</A></CODE>" operator will
    immediately define the output profile.  </P>
</DL></P>

In summary...
<UL>
<LI>The  "<CODE><A HREF="../option_link.cgi?profile" >-profile</A></CODE>" must
    be placed between the input and output file.
<BR>This is actually standard <A HREF="../basics/#cmdline"
    >IM Command Line Processing Practice</A>.
<LI>Use "<CODE><A HREF="../option_link.cgi?profile" >+profile</A></CODE>" with
    '<CODE>icm</CODE>' to remove any icc-profile present.
<LI>The first "<CODE><A HREF="../option_link.cgi?profile" >-profile</A></CODE>"
    then given, is the input profile.
<LI>The second "<CODE><A HREF="../option_link.cgi?profile" >-profile</A></CODE>"
    given, is the output profile.
</UL></P>

As such to use profiles for ALL images, you will need three "<CODE><A
HREF="../option_link.cgi?profile" >-profile</A></CODE>" operations: remove,
input, and output profile options. </P>

For Example,
If the input image already has a color profile then only one is needed.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick <I>rgb_image.jpg</I> -profile USCoat.icm <I>cmyk_image.jpg</I>
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

But if the image doesn't (or you know it is a RGB image, without an existing
profile), you can use...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
    magick <I>rgb_image.jpg</I> +profile icm \
            -profile sRGB.icc  -profile USCoat.icm <I>cmyk_image.jpg</I>
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

This sets the resulting image to a CMYK USCoat.icm profile. Another CMYK
profile is the SWOP.icm profile. </P>

For the reverse (image already has a profile) use...
<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
    magick <I>cmyk_image.jpg</I> -profile sRGB.icc <I>rgb_image.jpg</I>
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

<B>WARNING:</B></P>

If the original image already contains a profile, for example a CMYK profile,
then given two profile conversions is a bad idea. </P>

For example
<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
    magick <I>cmyk_image.jpg</I> -profile "CMYK.icc" -profile "RGB.icc" \
                  <I>output_image.jpg</I>
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

Will result in a CMYK -> CMYK -> RGB conversion.  But as CMYK is not symmetric,
the  the extra conversion step can result in a disastrous color conversion.
(See the IM Forum discussion <A HREF="../forum_link.cgi?t=12900" >Question on
ICC profile conversion behaviour</A>) </P>


<BR>

<A NAME="color_profile_mods"></A>
<H4>Color Profile Modification</H4>

The images you want to magick should all have ICC profiles embedded.
As such to magick your images with same a CMYK ICC profile...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick <I>rgb_image.jpg</I> -profile CMYK_PROFILE <I>cmyk_image.jpg</I>
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

This will magick using perceptive intent, the default (see <A
HREF="http://www.cambridgeincolour.com/tutorials/color-space-conversion.htm"
>Color Space Conversion</A> for an detailed explanation on rendering
intents). Because the results via perceptive intent can differ greatly
depending on the software that was used to create the ICC profiles, you can
use "<CODE><A HREF="../option_link.cgi?black-point-compensation"
>-black-point-compensation</A></CODE>" along with "<CODE><A
HREF="../option_link.cgi?intent" >-intent</A>&nbsp;relative</CODE>" to get a
result that is somewhat nearer to what one might expect.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick <I>rgb_image.jpg</I>  -intent relative -black-point-compensation \
          -profile CMYK_PROFILE     <I>cmyk_image.jpg</I>
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/reminder.gif" WIDTH=20 HEIGHT=16
    ><IMG SRC="../img_www/space.gif"   WIDTH=20 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
  Both "<CODE><A HREF="../option_link.cgi?black-point-compensation"
  >-black-point-compensation</A></CODE>" and "<CODE><A
  HREF="../option_link.cgi?intent" >-intent</A></CODE>" settings need to be
  specified before the "<CODE><A HREF="../option_link.cgi?profile"
  >-profile</A></CODE>" operation for it to be effective.
</I></FONT></TD></TR></TABLE></P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/warning.gif"  WIDTH=28 HEIGHT=28
    ><IMG SRC="../img_www/space.gif"   WIDTH=12 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
    The "<CODE><A HREF="../option_link.cgi?black-point-compensation"
    >-black-point-compensation</A></CODE>" option was added to IM v6.2.7-0.
</I></FONT></TD></TR></TABLE></P>

You can download color profiles from  <A
HREF="http://www.color.org/srgbprofiles.xalter" >International Color
Consortium</A>. </P>



<H4>EXIF InterColorProfile</H4>

On top of the above Color Profile handling, many Digital Cameras, save color
profile information in the EXIF profile attribute
'<CODE>InterColorProfile</CODE>'.  This attribute is meant to be "<I>assumed in
the event of no colour profile being embedded</I>", according to the document,
"<A HREF="http://www.computer-darkroom.com/ps7_colour/ps7_1.htm" >Colour
Management and Adobe PhotoShop 7</A>". </P>



<A NAME="profile_iptc"></A>
<H3>IPTC Profiles</H3>

The IPTC profile is used in images to store identification attributes of the
image, such as caption, credit, author, keywords, etc. </P>

If you want to add an IPTC profile to an image, you need a single -profile:

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick <I>image.jpg</I> -profile iptc <I>iptc_image.jpg</I>
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

If an image contains a profile you can save it with this, so you can add that
profile to other similar images:

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick <I>iptc_image.jpg</I> iptcData.iptc
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

Or you can extract a text version of the profile that you can edit
<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
    magick <I>iptc_image.jpg</I> IPTCTEXT:iptcData.pro
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

Here for example is a profile contributed by <I><A
HREF="../forum_link.cgi?u=8641" >fcaserio</A></I> in the <A
HREF="../forum_link.cgi?t=8688" >IM Forums</A>.

<DIV ALIGN=center>
<!--<CODE EXECUTE>
  txt2gif iptcData.pro
</CODE>-->
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="../images/iptcData.pro"
      ><IMG SRC="iptcData.pro.gif"
            ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>

You can add this profile to an image using

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick <I>image.jpg</I> +profile 8BIM -profile 8BIMTEXT:iptcData.pro \
          iptc_image.jpg
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

That image can be converted into an EPS (Encapsulated Postscript) with a TIFF
preview (EPT), that also contains the IPTC profile.  (Thanks <I>Tee Tanne</I>).

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick <I>itpc_image.jpg</I>  EPT:image.eps
</CODE></PRE></TD></TR></TABLE>
</DIV></P>


<A NAME="profile_xmp"></A>
<H3>XMP Profiles</H3>

Extract a XMP profile from a TIF image...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick picture.tif metadata.xmp
</CODE></PRE></TD></TR></TABLE>
</DIV></P>


<HR><!-- ---------------------------------------------------------------- -->

<A NAME="vector"></A>
<H2>A word about Vector Image formats</H2>

Their is more than one style of image storage in the world...
<TABLE WIDTH=90% ALIGN=center>
<TR valign="top"><TD><B>Raster</B>
<TD>Images which are stored and processed using arrays of colored pixels.
    Raster image formats include GIF, PNG, JPEG, TIFF, and so on.  Images can
    consist of multiple arrays (channels) representing different colors, and
    can have multiple images, layers, or frames (depending on usage) in the
    one image file format file. </P>

<TR valign="top"><TD><B>Vector</B>
<TD>Images are defined in terms of lines, thicknesses, tiles, gradients, and
    larger compound objects.  Formats include SVG, Postscript, PDF, FIG, DXF,
    WMF, and even TTF fonts.  It allows images to be resized, and even greatly
    enlarged <I>without loss of quality</I>.  Also while editing such formats,
    you can generally move whole objects around without destroying what is
    underneath (object layering). </P>

<TR valign="top"><TD><B>Fractal</B>
<TD>Images are a special rare case, used to achieve extreme compression of
    complex images, such as old paintings.  However the only usage I know
    about is in a very expensive commercial product.  Outside that usage it is
    also used for complex mathematical objects such as Mandelbrot and Julia
    sets, and in generating randomized splashes of color in screen savers
    (IFS). It is very rarely seen. </P>

</TABLE></P>

Why is this important?  Because IM is a 'raster image processor', and while it
can read or write images stored in one of the vector formats it does so by
converting the image to and from an internal raster image. </P>

Consequently if you are trying to magick an image from a vector format, to
another vector format, IM will essentially rasterize this image at the
currently defined <A HREF="../basics/#density" >resolution or density</A>
which will hopefully (but unlikely) be suitable for the output device you
intend to use it on. </P>

In other words, any output from IM will never be a true vector format. While it
can magick its internal raster format into a vector format file, the result
is only a superficial vector image wrapper around an image in raster format.
And unless the raster image is defined properly (at the right resolution) for
the output device, the result will not be particularly good. </P>

Unfortunately new uses to IM do not know anything about this.  They see IM as
a converter that can magick say PDF to Postscript, producing images with
'blocky' aliasing effects, 'washed out' colors, or blurry images that just do
not look good at all, on the intended output device. </P>

Which brings use to what I am trying to say... </P>

<DIV ALIGN=center><B>
  Avoid using ImageMagick for 'Vector Image' to 'Vector Image' conversions
</B><BR>EG: converting between formats like:  PDF, PS, SVG
</DIV><P>

In other words, use the right tool for the right job. And for this situation,
ImageMagick is not the right tool. </P>

That is not to say IM can't be used to do such a conversion. After all most
printers and monitors actually rasterize the image themselves for the actual
printing onto a sheet of paper.  The difference is that the printer knows what
resolution it needs for the hardware it is using.  ImageMagick does not. </P>

For examples of converting vector images to rasters (and improving such
conversions), see the example <A HREF="../text/#postscript" >Postscript/PDF
pre-formatted Text and Graphics Input</A>, and for SVG and user generated
vector images see <A HREF="../draw/#svg" >SVG Image Handling</A>. </P>

You may also find the information on <A HREF="../text/#pointsize" >Font Size,
Resolution and Pointsize</A> useful, particularly with regard to the effect of
"<CODE><A HREF="../option_link.cgi?density" >-density</A></CODE>" on drawn
text fonts. </P>

<H4>Non-IM Alternatives</H4>

If you really do need to do general conversion between vector formats, the
program  <A
HREF="http://sk1project.org/modules.php?name=Products&product=uniconvertor"
>UniConvertor, Sk1 Project</A> (usually available as a standard linux package)
and the  <A HREF="http://scratchcomputing.com/projects/vectorsection/"
>VectorSection</A>  can be used to magick vector-to-vector without
actually rasterizing the images. </P>

For general conversion of Postscript to other vector formats, look at "<CODE><A
HREF="http://www.pstoedit.net/pstoedit" >pstoedit</A></CODE>", which is
typically available in your systems extra package repositories. Also look at
"<CODE><A HREF="http://www.ctan.org/tex-archive/support/epstopdf/"
>epstopdf</A></CODE>" which is part of the <A HREF="http://www.ctan.org/"
>Comprehensive TeX Network (CTAN)</A>.  TeX and LaTeX are UNIX documentation
(book and scientific article) text processing system. It has lots of tools to
do with Postscript and PDF formats. </P>

For SVG to PDF conversion, Wolfgang Hugemann &lt;Auto&#64;hugemann.de&gt;
suggests that the easiest vector to vector conversion was to magick display the SVG
in a browser (Firefox) and the print it using a PDF printer driver. Though the
"Uniconvertor" could be used too. </P>

<HR><!-- ---------------------------------------------------------------- -->

<A NAME="other"></A>
<H2>Other Image File Formats</H2>

There are of course a huge number of other image file formats that IM can use
and understand, however using many of these less 'common' formats are
specialized for some specific purpose, and often require some tweaking or other
options to get them to perform the way you want them to perform. </P>

I do not recommend these file formats, and generally I myself don't used them.
However I do try to log various notes, techniques, and options that have been
reported on the IM mail list, or <A HREF="../forum_link.cgi?f=1" >IM
forum</A>, so others may also use the information gleaned.</P>

Many of the notes are in a raw, unprocessed form, and I am willing to accept
further contributions, ore re-writes to the notes below. </P>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="ps"></A>
<A NAME="eps"></A>
<A NAME="pdf"></A>
<H3>Postscript (PS, EPS) and Adobe PDF</H3>

For basic handling see <A HREF="../text/#postscript" >Postscript Text
Handling</A> and the warning about <A HREF="#vector" >Vector Image
formats</A>. </P>

The major problem with Postscript and its related formats (like PDF) is that
it is a complex page formatting language.  That is the format is a program
and not really an image format!  That means IM is forced to rely on
another external program (or delegate) to 'run' the program and return the
generated image. </P>

<H4>Encapsulated Postscript (EPS)</H4>

Encapsulated Postscript is actually exactly the same as normal postscript (a
vector image format) except it is a single page image, and a "Bounding Box'
entry is present to define the exact area the image covers. </P>

The format was designed to to allow other programs to move and scale the image
when inserting the postscript it defines into other postscript documents. </P>

IM handles it in basically the same way as postscript.  (See above). </P>

<PRE>  magick image.jpg -compress none eps2:image.eps</PRE>

Use "EPS2:" or "EPS3:" to create JPEG compressed EPS files:

Note: Adding profiles to EPS images are on the 'to do' list but is
currently not supported. </P>


<A NAME="ps_reading"></A>
<H4>Postscript/PDF Input </H4>

As this format is a vector image format it is effected by settings such as
"<CODE><A HREF="../option_link.cgi?page" >-page</A></CODE>", and "<CODE><A
HREF="../option_link.cgi?density" >-density</A></CODE>". </P>

Examples of reading Postscript (which is the same for EPS and PDF format) are
provided in <A HREF="../text/#postscript" >Postscript Formatted Text</A>, and
you should read this first. </P>

However the reading of these formats is very complicated, as they are full
computer languages designed specifically to generate a printed page on high
quality laser printers.   This is well beyond the scope of ImageMagick, and so
it relies on a specialized delegate program known as "<A
HREf="http://www.ghostscript.com/" >ghostscript</A>" to read, and convert
Postscript and PDF pages to a raster image. </P>

<B>One point.</B>  As IM uses Ghostscript to rasterize a postscript file at
a specific resolution, any raster images that are in the postscript file
will often be blurred, or distorted, unless the exact density for that
raster image is known.  This also assumes that the postscript program
itself does not rotate or otherwise manipulate the raster image. </P>

In fact, multiple delegates are present and selected by IM depending on the
situation.  For example the '<CODE>ps:color</CODE>' (using the
'<CODE>bmpsep8</CODE>' ghostscript device) verses '<CODE>ps:alpha</CODE>'
(using '<CODE>pngalpha</CODE>') is selected depending on if "<CODE>-channel
RGBA</CODE>" had been set or not. </P>

The '<CODE>ps:color</CODE>' delegate is used rather than
'<CODE>ps:alpha</CODE>' by default because the '<CODE>pngalpha</CODE>'
ghostscript device only supports an one page/one image and PDF's generally are
multi-page.  Use "<CODE>-channel RGBA</CODE>" before reading the image to
select the '<CODE>pngalpha</CODE>' delegate method. </P>

If all you want is the number of pages, using ghostscript can be a lot
faster.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  gs -q -sPDFname=document.pdf   pdfpagecount.ps
  %%Pages: 96
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

<B>Windows and Ghostscript</B> is a little more complex, as it requires the
use of the windows registery. </P>


<A NAME="pdf_reading"></A>
<H5>Special ImageMagick PDF Reading options</H5>

Special options for PDF handling...
<DL>
<DT><CODE>-units PixelsPerInch</CODE>
<DD>Should be set when handling PDF documents (reading or creation of).
    I am not sure what this does but reports indicate it
    should be set for correct working. </P>

<DT><CODE>-define pdf:use-cropbox=true</CODE>
<DD>Use a 'cropbox rather than the default 'mediabox' as per Adobe generated
    PDF files.  (Basically adds a "<CODE>-dUseCropBox</CODE>" to the
    ghostscript conversion from PDF images. </P>

    NOTE: This works if your PDF only has one page, but if it is a multiple
    paged PDF, it won't crop correctly. </P>

<DT><CODE>-define pdf:use-trimbox=true</CODE>
<DD>Use a 'trimbox rather than the default 'mediabox' as per Adobe generated
    PDF files. </P>

</DL>

<A NAME="ps_delegate"></A>
<H5>Modifying the Input Delegate</H5>

Modifying the system delegate is dangerous and a mistake could render IM
unable to read postscript/PDF files.  You also may need administration
privileges, as you cannot replace a system defined delegate with a personal
delegate, due to security ('hacker') measures. </P>

See <A HREF="../files/#delegates" >Delegates and Coders for Image Formats</A>
for more info on the delegate XML syntax and meaning, and creating personal
input/output delegates. </P>

On the forum topic <A HREF="../forum_link.cgi?t=8546" >Convert EPS to JPG
Unreliable</A>, it was suggested that you edit your system
"<CODE>delegates.xml</CODE>" and replace "<CODE>-sDEVICE=bmpsep8</CODE>" to
"<CODE>-sDEVICE=bmp16</CODE>".  Other users have found that changing this to
"<CODE>-sDEVICE=pnmraw</CODE>", also works better.  I have not tried this
myself, so can provide no guarantees about this, or what versions of
Ghostscript this applies to.  If you have any further info, please let me
know. </P>

If you have a CMYK postscript or PDF file then the page <A
HREF="http://john.ukmn.com/2007/06/19/imagemagick-cmyk-to-rgb/" >Blog of
John</A> details how you can modify the delegate entry (Add a
"<CODE>-dUseCIEColor</CODE>" ghostscript option) so ghostscript convert
handles this this of postscript. </P>

Another possibility is to create a personal "<A HREF="../files/#delegate"
>Delegate</A> which would invoke pdftoppm.  Say the tag is called
"<CODE>pdfalt</CODE>" which invokes the program "<CODE>pdftoppm</CODE>"
or even "<CODE>pdfimage</CODE>" from the "<CODE>xpdf</CODE>" package. </P>

Then your magick stream would look something like this:

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick pdfalt:image.pdf image.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

<I>Anyone like to give the delegate creation a go? Let us know!</I></P>

You may also like to try using "<CODE>pstoedit</CODE>" which can convert
a postscript file to other vector formats, or passes the postscript into the
ImageMagick API, to magick it to bitmap.  I have not experiment or tested
this, and would like some feedback. </P>

<A NAME="pdf_images"></A>
<H3>PDF Raster Image Extraction</H3>

The rendering of any PDF pages to a specific size or 'density' is at the heart
of the vector graphics using by PDF. It works great for text, or line
drawings.  But this also means that any raster image (pixel array) within the
PDF has to be resized.  But resizing is a 'lossy' operation, resulting in
some image degrading, unless you use the original density of that raster
image, which can vary from image to image within the PDF! </P>

It is thus advantageous to be able to extract the raster images from a PDF
without any 'density' reference. </P>

You can extract the raster images directly using "<CODE>pdfimages</CODE>"
program, which is part of either the <A
HREF="https://poppler.freedesktop.org/" >poppler-utils</A> or the "<A
HREF="http://www.foolabs.com/xpdf/" >xpdf-utils</A> software packages.  These
software packages also contain many other tools that you can find useful for
PDF processing. See <A HREF="http://blog.alivate.com.au/poppler-windows/"
>Poppler for Windows</A> and <A HREF="http://www.xpdfreader.com"
>Xpdf Reader</A>.  </P>

You may also like to look at the "<CODE>mutool</CODE>" from the package "<A
HREF="http://mupdf.com" >MuPDF</A>" by the same people that look after
GhostScript. </P>

An online tool to extract text and images is <A
HREF="https://www.sumnotes.net/" >Sumnotes</A> (commercial with limited free
trial). </P>

At a lower level Wolfgang Hugemann says you can extract any image contained by
a PDF (especially from PDF's generated by scanners).  Basically by extracting
any byte sequence between "stream" and "endstream", and saving as a separate
file. </p>

<A NAME="pdf_text"></A>
<H3>PDF Text Extraction</H3>

You can use the GhostScript program "<CODE>ps2ascii</CODE>" or
"<CODE>pstotext</CODE>".  </P>

Or as an alternative that does both text and images, have a look at
"<CODE>pdftohtml</CODE>" has an XML output that Ross Presser reports is
"<I>pretty good at reassembling paragraphs.</I>". </P>

Also the "<CODE>pdftk</CODE>" program can 'uncompress' a PDF so it can be
edited directly, and to 'repair' corrupt PDF's. </P>

<A NAME="pdf_options"></A>
<H4>Postscript/PDF Output Options</H4>

The following settings are known to effect the output of Postscript,
Encapsulated Postscript, and PDF image formats:
"<CODE><A HREF="../option_link.cgi?page" >-page</A></CODE>",
"<CODE><A HREF="../option_link.cgi?gravity" >-gravity</A></CODE>",
"<CODE><A HREF="../option_link.cgi?compress" >-compress</A></CODE>",
"<CODE><A HREF="../option_link.cgi?density" >-density</A></CODE>",
</P>

By default no compression is used on PDF image output, so PDF files can often
be a lot bigger than necessary.  The following table equated the IM compression
modes with the resulting Postscript compression mode used. </P>

<A NAME="pdf_compression"></A>
<DIV ALIGN=center>      <B>PS/PDF Compression Meanings</B>
<TABLE BORDER=1>
<TR><TH>Compression <TH>image '<CODE>/Filter [ ... ]</CODE>' setting
<TR><TD>"<CODE>-compress none</CODE>" <TD> '<CODE>/ASCII85Decode</CODE>'
<TR><TD>"<CODE>-compress zip</CODE>"  <TD> '<CODE>/FlateDecode</CODE>'
<TR><TD>"<CODE>-compress jpeg</CODE>" <TD> '<CODE>/DCTDecode</CODE>'
<TR><TD>"<CODE>-compress lzw</CODE>"  <TD> '<CODE>/LZWDecode</CODE>'
<TR><TD>"<CODE>-alpha off -monochrome -compress fax</CODE>"&nbsp;
                                      <TD> '<CODE>/CCITTFaxDecode</CODE>'
<TR><TD>"<CODE>+compress</CODE>"
    <BR>"<CODE>-compress rle</CODE>"
    <BR>&nbsp; &nbsp; <FONT SIZE=-2>any thing else</FONT>
                                      <TD> '<CODE>/RunLengthDecode</CODE>'
</TABLE></DIV></P>

Recommended compressions for PDF is  Zip  (Deflate Compression) or
Group4 (Fax) compression.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick image.gif -alpha off -monochrome -compress Zip -quality 100 \
          -units PixelsPerInch -density 600  image_deflate.pdf

  magick image.gif -alpha off -monochrome -compress Group4 -quality 100 \
          -units PixelsPerInch -density 600  image_group4.pdf
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

These two commands produce much smaller PDF files than a direct conversion, of
a black an white page.  However which is smaller depends on the image and is
impossible to determine without trying and testing the resulting size. </P>

<A NAME="ps_alturnatives"></A>
<A NAME="pdf_alturnatives"></A>
<H4>Postscript/PDF Output Alternatives</H4>

Remember that PDF is a vector image (document) format, and IM is a raster
image processor.  This means that any PDF document IM creates will basically
consist of a single raster image per page. </P>

The images output in the PDF document will be fixed at a specific resolution
(or pixel density), which can cause pixel distortion issues when viewed or
printed at some other resolution.  Also for text documents, using a raster
image is wasteful, as plain text with fonts and formatting meta-data will
always be a lot smaller and render better than a scanned raster image of the
text. </P>

Because of this, other PDF creation programs may be better suited to your
needs.  This will let you keep images as images, and text and text, allowing
you position the text and images together in a nicer more logical way, as well
as insert text, and overlay arrows or connecting lines, in a more logical
fashion. </P>

For example I suggest you look at the support programs provided by the
TeX and LaTeX system.  See <A HREF="http://www.ctan.org/" >Comprehensive TeX
Network (CTAN)</A>. </P>

Another tool set is  <A HREF="http://multivalent.sourceforge.net/Tools/"
>Multivalent Document Tools</A>. </P>

Of course such programs are harder to automate, however I have in the past use
the simple FIG vector graphic file format (see <A HREF="http://www.xfig.org/"
>Xfig</A>) to generate Postscript and PDF documents with text and graphics
placed in an automatic way. </P>


<B>Image to PDF convertors</B>... </P>

The tool <A HREF="http://code.google.com/p/sam2p/" >sam2p</A> which is
specialized in converting images to PDF files.  So does all the preprocessing
with ImageMagick and then making the final conversation using
"<CODE>sam2p</CODE>". It even brings a small script to adjust the result to an
A4 paper. </P>

From <A HREF="http://sam2p.googlecode.com/svn/trunk/README" >sam2p README</A>:
<TABLE WIDTH=90% ALIGN=center>
<TR valign="top"><TD>Q58)
<TD>Can sam2p generate a PDF which is scaled proportionally (i.e. keeping
    the aspect ratio) to a specified page size, and centered on the page?
<TR valign="top"><TD>A58)
<TD>No, but the Perl script sam2p_pdf_scale.pl bundled with sam2p can
    post-process the file created by sam2p. For example, to scale and
    center a PDF on an A4 paper, do:

<PRE><IMG SRC="../img_www/text_top.gif" ALT="----8<----" WIDTH=120 HEIGHT=10>
sam2p input.img output.pdf
sam2p_pdf_scale.pl 595 842 output.pdf
<IMG SRC="../img_www/text_bot.gif" ALT="----8<----" WIDTH=120 HEIGHT=10></PRE>
</TABLE></P>

Unfortunately it doesn't work with default PDFs created by IM. </P>

-- Sebastian Krause, from the IM Users Mailing List </P>



<B>Multi-paged PDF Documents</B>... </P>

You can use perl to combine multiple PDF files, without resorting to an IM, and
its rasterization problem...

<BLOCKQUOTE>
<PRE><IMG SRC="../img_www/text_top.gif" ALT="----8<----" WIDTH=120 HEIGHT=10>
#!/usr/bin/perl
#  Script   pdf-combiner.pl
use strict;
use warnings;
use PDF::Reuse;

prFile('combo.pdf'); # Output.
for (qw/a b c d/) # Inputs.
{
  prImage("result_$_.pdf");
  prPage();
}
prEnd();
<IMG SRC="../img_www/text_bot.gif" ALT="----8<----" WIDTH=120 HEIGHT=10></PRE>
</BLOCKQUOTE></P>

You can also use a JAVA toolkit to merge IM generated images into a PDF
producing a better PDF than a simpler one that IM will generate...

<BLOCKQUOTE>
<PRE><IMG SRC="../img_www/text_top.gif" ALT="----8<----" WIDTH=120 HEIGHT=10>
#!/bin/bash

for x in ./*.jpeg
do
    echo $x to ${x}.pdf
    magick $x -quality 75 ${x}.pdf
done

echo Merging...
java tool.pdf.Merge *.pdf
<IMG SRC="../img_www/text_bot.gif" ALT="----8<----" WIDTH=120 HEIGHT=10></PRE>
</BLOCKQUOTE></P>

Another user on <A HREF="../forum_link.cgi?t=13126" >IM Discussion Forums</A>
also suggested using <A HREF="http://www.warwick.ac.uk/go/pdfjam" >PDFjam</A>
to merge multiple PDF pages together. </P>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="netpbm"></A>
<A NAME="pbmplus"></A>
<H3>PbmPlus / NetPBM Image File Format:
<FONT SIZE=-1> PBM PGM PPM PNM PAM</FONT></H3>

The PbmPlus or  "<A HREF="http://netpbm.sourceforge.net/" >NetPBM</A>" image
manipulation filters (unix command line). </P>

These image formats come in a variety of styles "<CODE>PBM</CODE>" (bitmap),
"<CODE>PGM</CODE>" (grayscale), "<CODE>PPM</CODE>" (color), "<CODE>PFM</CODE>"
(floating point, for HDRI),  "<CODE>PAM</CODE>" (arbitrary format), and
"<CODE>PNM</CODE>" (any NetPBM format). Each of these (except
"<CODE>PAM</CODE>" and "<CODE>PFM</CODE>") can also be either in a 'raw'
binary form (the default when writing by either IM or NetPBM) , or as plain
ASCII text format, (set using "<CODE><A HREF="../option_link.cgi?compress"
>-compress</A> None</CODE>"). IM can of course read any of them. </P>

The format should be regarded as using "linear-RGB" colorspace only, and NOT
using "sRGB" as most other image file formats. However a depth of 16 should be
used when using "linear-RGB" so caution is recommended to avoid heavy round
off errors with depth 8 images. </P>

The NetPBM formats typically saves one image per file. However IM, and many
other NetPBM utilities will read and write files with multiple images simply
concatinated together. As such when writing images it may be a good idea to
set the appropriate "<CODE><A HREF="../option_link.cgi?adjoin"
>-/+adjoin</A></CODE>" setting when writing files. (See <A
HREF="../files/#adjoin" >Writing Multiple Image Sequences</A> for details).
</P>

The PPM file format is actually especially important to ImageMagick as it is
the communication format used during the conversion of Postscript and PDF
images via the "<A HREf="http://www.ghostscript.com/" >ghostscript</A>"
delegate. It is also a major format for video image processing such as from
the "<A HREF="http://ffmpeg.org/" >ffmpeg</A>" command. </P>

Any 'quality' or value range can be used on input (up to 16 bit or 65535
'depth'). For example here is a highly unusual value range of 5, to generate
a 'step gradient'. I know of no other image format that allows you to use such
an odd-ball quality range.

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
  echo "P2 6 1 5   0 1 2 3 4 5" | \
      magick - -scale 120x20  pgm_step_gradient.gif
</CODE></PRE></TD></TR></TABLE>
</TD><TD>
  <A HREF="pgm_step_gradient.gif"
     ><IMG SRC="pgm_step_gradient.gif"       WIDTH=120 HEIGHT=20
           ALIGN=middle VSPACE=0 HSPACE=5 BORDER=1 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

Also look at <A HREF="../canvas/#gradient_resize" >Resized Gradients</A> were
NetPBM text images are used to create very small (2 to 4 pixel) images.  </P>

The above also demonstrates just how useful the 'ASCII' sub-formats can be.
Espectally as a way of added images into shell scripts, or as a means of
generating images from an array of numbers.  For example see <A
HREF="../files/#txt" >TXT: Enumerated Pixel Format</A>.  </P>

One example of this usage is shown in the <A
HREF="../color_mods/#redist_method" >Histogram Redistribution Methodology</A>
examples. </P>

<A NAME="pbmplus_imagemagick"></A>
<H4>PbmPlus/NetPBM vs ASCII Data Format</H4>

Its ASCII output is probably the cleanest method of extracting the color
values from a specific image, which again makes it idealy suitable for script
and simple image processing.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE TXT2GIF REPLACE>
  magick -size 20x2 xc: +noise random -channel G -separate +channel \
          -depth 16  -compress none   pgm_random_values.pgm
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="pgm_random_values.pgm"
    ><IMG SRC="pgm_random_values.pgm.gif"
          ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>

Note that when the output is plain text, and lines are not written so as to
line up with the images  row length. But you can re-format the output using
the various UNIX text utilities. For example you can use the "<CODE>tr</CODE>"
text utility to replace and compress multiple commas and spaces to single
newline, will place all values one value per line, making it easier for
a script to process. </P>

Also with IM you can only specify 'depth' of 8 or 16 for the output quality
for PGM and PPM.  While the PbmPlus formats allows the use of any 'maxval' for
its values, even one that is not a power of two!  It does have a hard limit of
16 bit depth (maxval 65535).  A finer control of the actual 'maxval' of the
NetPBM image is currently not possible, though could be added via a special
coder setting in the future. (if requested). </P>

Here is another example outputing a 9x9 array of grayscale values from 0 to
255, extracted from the rose built-in image.  I used "<CODE>pnmtopnm
-plain</CODE>" so we get a newline at the end of each pixel row.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE TXT2GIF OUT=pgm_array.pgm>
  magick rose:[9x9+0+0] -colorspace gray -transpose -depth 8 PGM:- |\
    pnmtopnm -plain
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="pgm_array.pgm"
    ><IMG SRC="pgm_array.pgm.gif"
          ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>

Older variants of this NetPBM command include "<CODE>pnmnoraw</CODE>" and
"<CODE>pnmtoplainpnm</CODE>", to do the same thing as "<CODE>pnmtopnm
-plain</CODE>".  Check your NetPBM packages man page, as the developers can't
seem to make up their minds as to how it should be done. </P>

Any of these PbmPlus programs will output a newline at the end of 'image row',
which the ImageMagick coder does not do.  This can make image processing in
scripts a lot easier.  </P>

Here is an example of outputing a very small ASCII PBM bitmap.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE TXT2GIF OUT=pbm_array.pbm>
  magick label:O pbm: | pnmtopnm -plain
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="pbm_array.pbm"
    ><IMG SRC="pbm_array.pbm.gif"
          ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>

Note that PBM bitmaps does not even need to output spaces between values,
though they are allowed (IM outputs them, PbmPlus utilities do not).  Also
note that for bitmaps white='<CODE>0</CODE>' (background) and
black='<CODE>1</CODE>' (foreground). This is a standard for bitmaps formats
like XBM and PBM, and ImageMagick understands this convention. </P>

If this is not desirable <A HREF="../color_mods/#negate" >Negate</A> the
image, or use <A HREF="../color_mods/#level-colors" >Level Images by Color</A>
to set the desired colors of the bitmap image. </P>


<A NAME="pbmplus_depth"></A>
<H4>PbmPlus/NetPBM Depth Control</H4>

Sometimes you want more control of the depth of PGM and PPM images, for
example to use a percentile range of values from 0 to 99. </P>

One method is to use the NetPBM program "<CODE>pamdepth</CODE>", which can
magick images to any range (up to internal limits of 65335). Here for example
is an image array of values but using a 0 to 99 range of output values.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE TXT2GIF OUT=pgm_percent.pgm>
  magick -size 9x9 radial-gradient: -depth 16 PGM:- |\
    pamdepth 99 | pnmtopnm -plain
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="pgm_percent.pgm"
    ><IMG SRC="pgm_percent.pgm.gif"
          ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>

Here is another example but this time using the <A
HREF="../color_mods/#level_plus" >Reversed Level</A> operator to set output
value range. This can give you more control over the transformation of values,
but the 'maxval' in the PGM image does not match the max value of the image.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE TXT2GIF OUT=pgm_percent_2.pgm>
  magick -size 9x9 radial-gradient: +depth +level 0,99 PGM:- |\
    pnmtopnm -plain
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="pgm_percent_2.pgm"
    ><IMG SRC="pgm_percent_2.pgm.gif"
          ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>

The "<CODE><A HREF="../option_link.cgi?depth" >+depth</A></CODE>" in the above
command is vital to set the image file depth to the same as the IM quality
level.  All that is needed is to reset (or ignore) the third line to a value
of '<CODE>99</CODE>', and optionally compress the image back to a 'raw' binary
NetPBM image format.  However because PbmPlus/NetPBM has a maximum depth of
65535 (16 bit) this would only work for IM Q8 or Q16 versions. </P>


<A NAME="pbmplus_comment"></A>
<H4>PbmPlus/NetPBM Comments</H4>

IM will read, write, and preserve 'comment' lines in the header of the
PbmPlus/NetPBM file format.  For example...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE TXT2GIF OUT=pgm_comment.pgm>
  magick -size 2x2 xc:grey -set comment "by Anthony" -compress none PGM:-
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="pgm_comment.pgm"
    ><IMG SRC="pgm_comment.pgm.gif"
          ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>

However that said most applications including PbmPlus itself will ignore such
comments, and even lose them when it processes the file.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE NOIMAGE TXT2GIF OUT=pgm_comment_2.pgm>
  magick -size 2x2 xc:grey -set comment "by Anthony" PGM:- | pnmtopnm -plain
</CODE></PRE></TD></TR></TABLE>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD>
  <A HREF="pgm_comment_2.pgm"
    ><IMG SRC="pgm_comment_2.pgm.gif"
          ALIGN=middle VSPACE=0 HSPACE=0 BORDER=0 ALT="[IM Text]"></A>
</TD></TR></TABLE>
</DIV></P>


<A NAME="pbmplus_imagemagick"></A>
<H4>PbmPlus/NetPBM vs ImageMagick</H4>

The PbmPlus/NetPBM image processing suite was once a rival of ImageMagick for
command-line image processing, but uses a completely different (more low
level) pipeline filtering philosophy, for image handling and processing.  This
makes it easy to use in shell scripts, but more difficult to use for general
or very complex image processing. It also means the image is converted to and
from the image file format a lot more frequently, and generally requires the
use of many temporary files. </P>

PbmPlus/NetPBM images do not generally deal with Transparency (though the
newer PAM format does), and does not provide a general way of passing image
meta-data with the image data. </P>

All the PbmPlus/NetPBM formats (like the ImageMagick internal format, see <A
HREF="../files/#miff_stream" >MIFF Image Streaming</A>) can handle a magick stream of
multiple images, simply by concatenating or appending the images together, one
after the other. This makes it very well suited for pipelined, multi-image
streaming, methods of image processing, such as for video processing. However
be warned that some PbmPlus/NetPBM programs only deal with single images and
will not handle a magick stream of multiple images.  </P>

However as it is more low-level, and pre-dates ImageMagick, it is often
selected for raw image outputs such as video image output and handling.
PbmPlus images is also more often used for scientific data, and as such images
are typically stored as 'linear-RGB' colorspace rather than the more common
non-linear 'sRGB' colorspace.  Caution is advised. </P>

Both packages can co-exist, and I have been known to use a PbmPlus/NetPBM
implementation for some things, instead of ImageMagick.  Typically when using
a specific low level image processing, or scripting using arrays of values
stored in an image form.  The two packages work together well, and recommend
both be installed and used for serious image work. </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=90% ALIGN=center>
<TR valign="top">
<TD><IMG SRC="../img_www/reminder.gif" WIDTH=20 HEIGHT=16
    ><IMG SRC="../img_www/space.gif"   WIDTH=20 HEIGHT=16></TD>
<TD ALIGN=justify width="100%"><FONT SIZE=-1><I>
  I was actually the one to make the vital 1995 patch release of NetPBM,
  during a time when little work was being done on that software.  Because
  of this I have a good understanding of the PbmPlus software and its simple
  image file format. </P>

  Since then it has been redeveloped a number of times by different people,
  and finally seems to have become a proper open source project. The various
  programs seem to be maturing and start to work together better.  </P>

  However its main problems: an of lack of meta-data and complexity; remain.
  But its simplicity as a file format is its biggest advantage, making it
  ideal for very low level image and data manipulation. </P>

</I></FONT></TD></TR></TABLE></P>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="tiff"></A>
<H3>TIFF</H3>

<PRE>
  The TIFF format is the propriety format for PhotoShop.  However it is so
  bloated with features, and has been modified by just about every application
  that has cared to use it, that no program, not even photoshop can handle ALL
  its variations.  Photoshop however has the best chance at reading it.

  I would steer clear of the TIFF image file format unless you are
  specifically working with photoshop, or the application accepts no other,
  better defined, image file format.

  I don't use the TIFF image file format, or Photoshop. If you use this format
  with IM extensively, perhaps you would like to submit your findings to me,
  to include here.  That way you  can help your fellow TIFF users.

  Whether a specific software package can read a TIFF, all you can do is try
  it and see.  That is the problem with this format.



  TIFF and Density (resolution) in photoshop...

  See <A HREF="../basics/#density_photoshop">Photoshop and Density</A>
  for the details and solutions to this problem



  JPEG to TIFF conversion...

    magick image.jpg image.tif

  This will either save the image inside the TIFF file using JPEG compression
  (which was inherited from the JPEG input.  Or it will error such as...

      Error: "JPEG compression support not configured"

  This is caused by the TIFF library not including JPEG compression support.

  Either way  THIS IS BAD.

  You can get around this problem by changing the setting to use a different
  compression algorithm:

      magick image.jpg -compress zip  image.tif
      magick image.jpg -compress lzw  image.tif
      magick image.jpg +compress      image.tif

  WARNING:  -compress Group4  with a TIFF works, but ONLY if you remove all
  transparent and semi-transparent pixels from the image.  Typically you can
  make sure this is done the same way as JPEG images above, using
     -background {color} -alpha remove
  See <A HREF="../masking/#remove" >Removing Transparency from Images</A>
  just before the final save (the first only works for single images).



  TIFF (and MIFF)  floating point precision files (Add to IM v6.2.6-5)...

  This is especially good for HDRI image processing (which uses floating point
  inside IM itself)

  For single precision (float) set...
         -depth 32 -define quantum:format=floating-point
  For do8uble precision (doubles) set...
         -depth 64 -define quantum:format=floating-point

  14 bit TIFF images...
       magick logo: -sharpen 0x1 -depth 14 logo.tif

       tiffinfo logo.tif

       Image Width: 640 Image Length: 480
       Resolution: 72, 72 (unitless)
       Bits/Sample: 14
       Compression Scheme: LZW
       Photometric Interpretation: RGB color
       FillOrder: msb-to-lsb
       Orientation: row 0 top, col 0 lhs
       Samples/Pixel: 3
       Rows/Strip: 2
       Planar Configuration: single image plane
       DocumentName: logo.tif
       Software: ImageMagick 6.2.8 07/27/06 Q16 https://imagemagick.org

  12 bit TIFF images...

  To magick 16-bit TIFF images to 12-bit:
        magick image.tif -depth 12 image-12.tif

  Pure black and white images...

       magick image ...  -type truecolor -type bilevel   image.tiff

    Results in normal images and the smallest filesize, and correct
    black/white handling in Photoshop, Microsoft Windows Picture and Fax
    Viewer.
       <A HREF="../forum_link.cgi?p=51723" >TIFF discussion</A>,
       <I><A HREF="../forum_link.cgi?u=7913" >RQuadling</A></I>.


  Enden and fill-order
    The order in which TIFF data values are stored is controled by
       -endien                   Global order of the bytes
       -define tiff:endian       Tiff format container endian
       -define tiff:fill-order   Bit order within a byte

    Each takes a value of either MSB (default) or LSB, however
    the "tiff:fill-order" will be set to the value of "tiff:endian"
    if that is defined, but not from the global endian value.

    The "tiff:endian" property is the endianess of the image container. The
    "-endian" property is the endianess of the image pixels. They may differ.


  Save a TIFF file format with only one row pre strip

          -define tiff:rows-per-strip=1.
    To save more rows per stripe increase the number
          -define tiff:rows-per-strip=8
    You can also specify the 'endian' ordering for binary integers in the format
          -endian MSB          -endian LSB

    For smaller TIFF images (other than by compression, you can also try to
    use options and settings like   -depth 8   to reduce the color quality
    or   +matte  to remove the alpha or transparency channel from the image.

    IM will save a greyscale image as a greyscale TIFF, if no non-grayscale
    colors are present. You can force it to save as non-greyscale with
          -depth 8  -type TrueColor


  Added IM 6.6.4-3
    Allow you to set the "Software Creation:" meta-data (property)
    to something other than "Image Magick 6.**"
        -set tiff:software "My Software"


  Windows Picture and Fax Viewer, Windows Explorer

    These can can only magick display TIFFs that have certain Photometric
    Interpretation values, such as RGB.  IM Options...
        -compress LZW -type TrueColor

    toggle the photometric interpretation  (Added IM 6.3.2-10)
        -define quantum:polarity=min-is-black
        -define quantum:polarity=min-is-white


  Multi-Page TIFF
    If you want to split a multi-page tiff into separate pages, IM may have
    problems as it will still use up a lot of memory to hold previous pages
    even if you use a command like...
        magick "a.tif[i]" b%03d.tif

    This might be regarded as a bug, or perhaps a future improvement.

    The better solution may be the non-IM "<CODE>tiffsplit</CODE>" program.


  TIFF and EXIF profiles

    Cristy reported: The libtiff delegate library supports the EXIF profile
    but it was unreliable and caused faults too often so we commented out the
    call.

    To get the EXIF attributes try this.

      magick identify -verbose -define tiff:exif=true image.tif

</PRE>

The TIFF format can have a bitmap mask in the form of a clip path, which can
be enable using the "<CODE><A HREF="../option_link.cgi?clip"
>-clip</A></CODE>" operator.

You can use that 'clip' mask your image with that path using...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE DO_NOT_EXECUTE>
  magick image_clip.tif  -clip \
          ...do_various_operations... \
          +clip-mask  image_masked.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

See <A HREF="../masking/#clip-mask" >Write or Clip Masks</A> for more details.

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->


<A NAME="bmp"></A>
<H3>BMP, Windows Bitmap</H3>
<PRE>
  The Windows desktop icon image format BMP (short for bit-mapped) is a very
  unfriendly image format and should probably be avoided if possible.

  ImageMagick supports 8, 24, and 32-bit BMP images.

  Add -colors 256 to the end your command line (before the output image
  filename) to create a 8 bit colormapped BMP image rather than a 24 bit BMP
  format.  Extra colors can be added to images after performing operations
  like rotates, and resize.  See Color Quantization for more info on -color.

  The presence of any transparency controls whether it uses a 24 (RGB) or 32
  bit (RGBA) format BMP image. You can use "+matte" to turn off transparency
  in an image.

  If all colors are gray-scale a 'directcolor' greyscale image is generated.
  I think -type truecolor will stop this behaviour.


  If you have an older program cannot read the default BMP4 images written by
  ImageMagick, (for example a Windows Background Image), you can enforce the
  generation of a BMP3 format image using...

       magick image BMP3:image.bmp

  This format should have no transparency and should be a 'printable image',
  whatever that means.  In other words 'Windows' compatible.

  However, if a PNG input file was used and it contains a gAMA and cHRM chunk
  (gamma and chromaticity information) either of which forces "convert" to
  write a BMP4. To get a BMP3 you need to get rid of that information. One way
  may be to pipeline the image though a minimal 'image data only' image file
  format like PPM and then re-save as BMP3.  Messy, but it should work.

      magick image.png  ppm:- | magick - BMP3:image.bpm

  IM can not produce BMP's at depth levels other than 8.  However you can
  use NetPBM image processing set to do the final conversion to other depth
  levels (This needs at least a Q16 version of IM)...

       magick image +matte -colors 16 ppm:- |\
         pnmdepth 4 | ppm2bmp &gt; image.bmp


  Format limitations....

  The header for a BMP2: format only allows the description of the width,
  height and bit depth (bits per pixel) of an image. The bit depth can be one of
  1, 4, 8 or 24.

  For comparison, the bmp3: format allows bit depths of 0, 1, 4, 8 ,16, 24 and
  32 and has extra fields which specify x and y resolution (in pixels per metre)
  and compression of the image data.
</PRE>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="ico"></A>
<H3>ICO</H3>
<PRE>
  To create a multi-resolution ICO format image simply create all the image
  sizes you require and write them all to the same ICO file.

    magick icon-16.bmp icon-32.bmp icon-64.bmp \
            icon-128.bmp icon-256.bmp   myicon.ico

  Update

    magick icon-256.png  \
            -define icon:auto-resize="256,128,96,64,48,32,16" \
            myicon.ico

You can now add this to you web pages using
  &lt;LINK REL="shortcut icon" HREF="myicon.ico"&gt;

However many web browsers will now accept most image formats, not just the
ICO format.

</PRE>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="crw"></A>
<A NAME="raw"></A>
<A NAME="cr2"></A>
<A NAME="dcraw"></A>
<H3>RAW Camera Image Formats (CRW,CR2,NEF,X3F,etc.)</H3>

Most digital cameras, with the exception of the Sigma Foveon sensor and some
Sony cameras, magick the image produced by the lens into digital data by using
millions of sensors which detect the brightness of one specific colour, Red,
Green or Blue. In order for the camera to respond to colour in approximately
the same way that the human eye does, there are twice as many green sensors as
there are of red or blue because our eye is much more sensitive to green light.
The sensors are arranged in what is called a Bayer array. For a description and
diagrams of this arrangement see, for example,
<A HREF="http://www.cambridgeincolour.com/tutorials/camera-sensors.htm"
>Understanding Digital Camera Sensors</A>. </P>

The conversion of the data from a Bayer array into the more familiar RGB pixels
requires a process called demosaicing. Once this operation has been done we
still do not have an image worth displaying. Even with the extra green pixels,
the camera's sensor still does not perceive colour the way we do. If you take a
piece of white paper and look at it in bright sunlight and then go indoors and
look at it under a fluorescent light, it will look white under both conditions.
But if you photograph the sheet of paper under those same conditions using
default camera settings, the paper will show slightly different colours when
displayed on a screen. The reason is that although the back of our retinas will
"see" the same light reflected off the paper as does the camera, our brain will
interpret that light for us and we will perceive the paper as white. The camera
simply measures the amount of red, green and blue light reflecting off the
paper and under a fluorescent light there will be more blue light than there is
under sunlight so the paper in that image will look bluer than the one taken in
sunlight. To produce images which both show a white sheet of paper requires
that they be "white balanced", also referred to as gray balanced or colour
balanced. For more about white balancing see <A
HREF="http://www.cambridgeincolour.com/tutorials/white-balance.htm"
>Understanding White Balance</A> </P>

There are still other aspects of the raw file which must be done, such as
setting a correct gamma, but without going into further detail it is clear that
the raw file needs a lot of processing before it can become an image that we
can view on a monitor. </P>

Camera raw files are often referred to as digital negatives. If you take a
photo and have the camera generate a JPG image, it will have done the
demosaicing and all the other adjustments. But if, for example, you forgot to
set the correct white balance in the camera before taking the photo, you can't
really do much with the JPG to correct the situation because so much
information about the original image has been lost. If, on the other hand, you
had produced a raw file from the camera instead of a JPG, during the conversion
from raw you can choose a particular white balance setting along with other
parameters and if the resulting image doesn't look right you can go back,
change the settings and magick it again until it does look right. This is
similar to the ability to produce more prints from film negatives. Without the
film negative you wouldn't be able to get an 8x10 blowup of one of the 4x6
snapshots you get when the film was first developed. </P>

While ImageMagick can handle a large variety of different formats, it does not
'know' how to magick raw camera files, so IM uses the "<CODE><A
HREF="http://www.cybercom.net/~dcoffin/dcraw/" >dcraw</A></CODE>" program as a
delegate program to magick the raw file into a format that it does understand,
either a TIFF (with the '<CODE>-T</CODE>' flag) or PNM.  Note that it is
designed for raw <I>camera</I> images, and not those from, for example, a
scanner.  The "<CODE><A HREF="http://www.cybercom.net/~dcoffin/dcraw/"
>dcraw</A></CODE>" program can handle a large number of different raw formats
including those from cameras manufactured by Canon, Fuji, Kodak, Nikon and
Sony. </P>

You can determine whether "<CODE>dcraw</CODE>" will recognize your raw files by
asking it to magick identify a sample. For example the command:

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  dcraw -i CRW_9641.CRW
</CODE></PRE></TD></TR></TABLE>
</DIV>

Which returns...

<DIV ALIGN=center>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE><FONT SIZE=-1
    >CRW_9641.CRW is a Canon EOS 10D image.</FONT
></CODE></PRE></TD></TR></TABLE>
</DIV>

When IM calls dcraw to do a conversion, using the <A HREF="../files/#delegate"
>delegate</A> (list using "<CODE>-list delegate</CODE>"), specifies two flags
which affect image processing: <DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE> dcraw -w -4 -O output_file input_file
    </CODE></PRE></TD></TR></TABLE> </DIV></P>

The '<CODE>-w</CODE>' flag means that dcraw will use the white balance
information in the raw file if it can be found. If the info can't be found,
dcraw will use an average of the whole image as a basis for white balancing.
</P>

The '<CODE>-4</CODE>' flag means that dcraw will only de-mosaic and white
balance the raw photo and output the result as a <I>16-bit linear image</I>
(48 bits per pixel), suitable for the default Q16 version of IM. </P>

Because '<CODE>-w</CODE>' and '<CODE>-4</CODE>' are the only two image
processing flags specified, there are some defaults that dcraw will use. The
output colour space will be sRGB and no ICC profiling is done (on my system,
dcraw was compiled without the LCMS library so it can't do profiling). </P>

The fact that the '<CODE>-4</CODE>' flag is set means that many processing
steps have been omitted, including levels adjustment and gamma correction, and
so the resulting image <I>will look dark</I>. The intention is that the user
is going to process the image with an image editor such as "Photoshop" or
"Paint Shop Pro", or even "ImageMagick" and do their own adjustment of the
levels, gamma and so on. In this case, the image should be output to a format
that supports 16 bits per colour.  (For example <A HREF="#tiff" >TIFF</A>).
</P>

<I>Note</I> that just because dcraw produces a 16-bit file doesn't mean that
all 16 bits contain useful data. For example, a raw image from a Canon 10D
digital SLR has 10 bits per colour. More recent cameras by Canon and other
manufacturers have 14 bits per colour. </P>

If you want your raw photos converted completely you will have to remove the
'<CODE>-4</CODE>' flag so that dcraw does the de-mosaicing, white balance,
brightness and gamma correction and so on. In this case dcraw outputs an
<I>8-bit file</I> (24 bits per pixel). If you are going to do further
processing of this image it would be best to output it as a <A HREF="#png"
>PNG</A> and avoid the <A HREF="#jpg" >JPEG compression artifacts</A>. The
JPEG format should only be used as a final step for actual use. In fact, it is
always a good idea to use a lossless format such as PNG (or IM internal format
MIFF) for intermediate steps in image processing. </P>

A special <A HREF="../files/#delegate_dcraw" >DCRaw Delegate</A> can be added
which will let you control how you read the 'raw' camera image formats. </P>

For further information look on the <A
HREF="http://www.cybercom.net/~dcoffin/dcraw/" >DCRaw WebSite</A>, and also
the <A HREF="http://www.guillermoluijk.com/tutorial/dcraw/index_en.htm" >DCRaw
Tutorial Website</A> which has some information about many of dcraw's optional
flags and including histograms of raw images using various flags. </P> Also
see <A HREF="http://www.camerahacker.com/Digital/dcraw_by_example.shtml"
>DCRaw by Example</A>. </P>


The above notes were first extracted from an IM Forum Topic <A
HREF="../forum_link.cgi?p=38051" >Converting RAW images</A>, by <I><A
HREF="../forum_link.cgi?u=11359" >jhfry</A></I>, with major re-writes by <I><A
HREF="../forum_link.cgi?u=3499" >el_supremo</A></I>. </P>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="mpeg"></A>
<H3>MPEG, M2V and AVI Movies</H3>
<PRE>
  IM is not very efficient at creating movies.  It will do the job though
  requires the external program "mpeg2encode" to do much of the dirty work.

  The problem is that IM is not designed to handle video, but static images or
  small sequences of images.  That is not to say it can't do it, but that is
  not its goal.  In particular it generally reads in all images into memory
  and process them from there.  For a large or long video this is not very
  efficient.

  For processing on a small sequence of frames however it really can't be
  beat.  In fact just about every Linux Video manipulation program uses
  ImageMagick to generate titles, fancy scene changes, and other effects to
  complete the post-processing development of a larger video development.  The
  process however is kept to small video sequences.

  However lets have a look at what IM can do.

  <B>Frames to Video</B>

  There are some reports that unless the images are the right aspect ratio is
  correct this will fail on older mpeg players,  use the MPEG II extension
  (m2v:) instead.

  Also use m2v to avoid heavy compression pixelization that can occur
  using...

      magick *.jpg glacier.mpg

  EG instead use...

      magick *.jpg m2v:glacier.mpg

  Note you may need lots of temporary space to do a large animations
  You can specify a different directory from the normal /tmp using...

      setenv MAGICK_TMPDIR /data
      magick -limit memory 0 -limit map 0 *.jpg image.m2v

Alternatives...

  To converting PNG images to MPEG2 Video streams, instead of MNG Multi
  PNG-files, use the following delegation...

       png2yuv -j file%08d.png -I p -f 25 -b 1 | \
         mpeg2enc -f 3 -q 3 -b 5000 -o out.m2v

  For more info see <A HREF="http://mjpeg.sf.net/" >mjpeg.sf.net</A>


  IM forums reported decent results with an open source project called "<A
  HREF="http://ffmpeg.org/" >ffmpeg</A>", which seems to be a fairly standard
  linux package install.

     ffmpeg -f image2 -i %03d.jpg -vcodec mjpeg -y anim.mpg

  Extracting an MVG with a transparent background
      magick -background none -size 320x240 sample.mvg out.png


  Michael Lenh wrote...
  I finally was able to create a very sexy video using mplayer

    mencoder "mf://data/p*.png" -mf fps=40 -o particle.avi -ovc lavc

  You can see the results at...

    http://www.mathematik.uni-ulm.de/~lehn/particle.avi
    http://www.mathematik.uni-ulm.de/~lehn/temperature.avi


  <A HREF="../forum_link.cgi?u=19117" >mabu</A> in a <A
  HREF="../forum_link.cgi?f=1&t=18724" >IM Forum Discussion</A> said to
  "<I>USE MENCODER, wow it's like 1000 times faster and actually WORKS</I>"...

     mencoder -nosound mf://*.jpg -mf w=800:h=371:type=jpg:fps=15 -ovc lavc -lavcopts vcodec=mpeg4:vbitrate=2160000:mbd=2:keyint=132:v4mv:vqmin=3:lumi_mask=0.07:dark_mask=0.2:mpeg_quant:scplx_mask=0.1:tcplx_mask=0.1:naq -o output.mpg

  It probably has extra options I don't need but it makes a nice time-lapse
  from .jpg files.


  Dean S. Messing uses transcode...

     find . -type f -name '*.png' | sort > filelist
     transcode -x imlist,null\
            --use_rgb\
            -y raw,null\
            -f 60\
            -i filelist\
            -g 4096x2160 \
            -j 540,1024,540,1024\
            -o video.avi\
            -H 0

   You can leave out -j  (clip window) if you want. -g is output size.

   Wolfgang Hugemann suggests a new alternative known as 'VirtualDub' under
   Windows Vista, which will let you run a video, or magick directly from
   a folder of image frames.

   WARNING: "<CODE>mplayer</CODE>" apparentally does not like mpeg file with
   only one frame. "<CODE>ffplay</CODE>" however seems to have no problems.


   <B>Video to Frames</B>

   Both "<CODE><A HREF="http://www.mplayerhq.hu/" >mplayer</A></CODE>" and
   "<CODE>mencode</CODE>" are more efficient at converting video into a series
   of frames than IM is.  On top of this is can handle just about any video
   (and audio) codec available.

   For example to grab 5 frames from 1 1/2 minutes into a video, scaled to
   320x240, you can use...

      mplayer file.mov -vf scale=320x240 -ss 01:30 -ao null \
              -vo png:z=3 -frames 5

   Other alternatives include the "<CODE><A HREF="http://ffmpeg.org/"
   >ffmpeg</A></CODE>" open source library, though that is also part of the
   "<CODE><A HREF="http://www.mplayerhq.hu/" >mplayer</A></CODE>" handling.

</PRE>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="mng"></A>
<H3>MNG, Multiple-image Network Graphics</H3>

<FONT SIZE=-1><I>Contributed by <A HREF="../forum_link.cgi?u=20882" >Barry
Loo</A> from the <A HREF="../forum_link.cgi?f=2&p=82783" >Example Ming
Animation</A> discussion.</I></FONT></P>

MNG (pronounce ming) is an open format based on PNG, and provides an animated
bitmap alternative to GIF and others. It allows for transparency (both semi
and full), compression (both lossy and lossless), and up to 32-bit color
depth. </P>

The increased color depth is what really sets this format apart from others.
GIF only supports up to 256 colors total, which is fine for many graphics;
however, photographs and gradients will suffer. </P>

Most animation options that can be used in creating GIF animations can also be
used to create MNGs. </P>

<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 width="100%" ALIGN=center>
<TR><TD width="100%" ALIGN=justify>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 width="100%" BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE EXECUTE>
magick -size 101x101 radial-gradient: \
        \( -clone 0 -level 00,100% +level-colors ,#F00 \) \
        \( -clone 0 -level 10,100% +level-colors ,#F12 \) \
        \( -clone 0 -level 20,100% +level-colors ,#F24 \) \
        \( -clone 0 -level 30,100% +level-colors ,#F36 \) \
        \( -clone 0 -level 40,100% +level-colors ,#F46 \) \
        -delete 0  -duplicate 1,-2-1 -set delay 1x30 -loop 0 pulsing.mng
</CODE></PRE></TD></TR></TABLE></TD><TD>
  <A HREF="pulsing.mng"
      ><IMG SRC="../img_www/doc_video.png"     WIDTH=48  HEIGHT=48
            ALIGN=middle VSPACE=0 HSPACE=5 BORDER=0 ALT="[IM Output]"></A>
</TD></TR></TABLE></P>

The above command generates a  radial-gradient image, which is then cloned and
adjusted to create a red to brighter red-orange pulse.  This is then
duplicated to create a reversed <A HREF="../anim_mods/#patrol" >Patrol
Cycle</A> before creating a 30 second, looped MNG animation. </P>

Unfortunately, most Web browsers do not currently support MNG, and many video
players only show one pass though the looped animation.  If you click on
the above missing image frame, you can download the animation and view it
using IM <A HREF="../basics/#animate" >Animate Command</A>. </P>

For more information on the MNG format, visit <A
HREF="http://www.libpng.org/pub/mng" >MNG Web Site</A>. </P>


<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="dpx"></A>
<H3>DPX, Digital Picture Exchange Format</H3>

This format is used in Motion Picture and Effects industry that makes
particular use of the extensive header information and the format's
flexibility in being able to handle high dynamic range and logarithmic colour
values at a variety of bit depths using RGB or YCbCr pixel descriptions. It is
based on, but largely supersedes, Kodak's Cineon format that has more a more
film specific header. </P>

One example of it's use would be when scanning film for use in post production.
Each frame would be stored as an individual .dpx file ranging from 2k (2048
pixels wide) to 8k (8192 pixels wide - for IMAX frames) at anything between 8
to 64 bits per colour component. A sequence of these might then be processed
using compositing software, altering the colour or adding visual effects. Once
complete they might then be recorded digitally to tape or projected back on to
film. </P>

The colour values for each pixel are often stored logarithmically (particularly
if the sequence is destined to be transferred back on to film) which more
naturally reflects the density of how colour information is stored in the
emulsion on the original film. When viewed without alteration logarithmic files
appear to have very low contrast, and so require a 'look up table' to translate
the logarithmic image to something that resembles what you might see if the
image was transferred back to film and projected in a cinema. Apart from making
the image linear (like most typical computer images) and adjusting the gamma
level this table sets where the black and white point lies. </P>

For a 10 bit logarithmic image where each colour component value ranges from 0
to 1023 the black and white points are normally set at 95 for black and 685 for
white. What this means is that the logarithmic file stores colour values that
are lighter than what the linear version will magick display as pure white and darker
than what it will magick display as pure black. This extra information therefore
remains available for an effects artists who might wish to alter the brightness
of the image after it has been stored as a dpx file. </P>

As an example, had this information been lost, reducing the brightness of an
image uniformly would result in highlights becoming darker, whereas with this
extra information the highlights instead reduce in size and start showing
details that were previously too bright to be seen. The latter is far closer to
what happens in the real world. </P>

The header can contain Film and/or Television specific data related to a
production. For example the television header can contain a SMPTE time code so
that shots exported as a dpx sequence from a production's edit can be easily
replaced once any effects have been added. The film header holds information
about the reel of film the frames originated from and various camera settings
that were used while filming. All these details will then stay with the images
as they are passed between post-production companies. </P>

<H3>Adding a time code to DPX files</H3>

You can add a time code to any dpx file using the following:

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick -define dpx:television.time.code=10000215 \
          originalFile.00001.dpx    alteredFile.00001.dpx
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

Carrying out this command for each of several thousand files that form a
sequence from a film or animation would clearly take a very long time. A
simple script can be used with ImageMagick to automatically increment the time
code for each frame in a sequence. </P>

For example see the Perl Script <A HREF="../scripts/dpx_timecode.pl"
>dpx_timecode.pl</A>. </P>

<BR>

A copy of the above was added to the main IM documentation at <A
HREF="http://magick.imagemagick.org/script/motion-picture.php" >Introduction
to Motion Picture Formats</A>. </P>

The above is courtesy of Seth Dubieniec &lt;seth.info_AT_dubieniec.co.uk&gt;,
from a long IM Forum Discussion on the DPX Format.  He is currently developing
DPX applications, so more DPX info is likely to be coming. </P>

<PRE><B>Extra Notes (unformatted)...</B>

Adding  -depth 10  causes IM to output a  10 bit DPX file.
-- James Fancher


If you want to set the gamma, for example, in the output DPX image...
     -define dpx:television.gamma=1.7

The colorspace of the DPX image is defined by the image element descriptor and
transfer-characteristic. If the transfer characteristic is
PrintingDensityColorimetric we set the colorspace to LogColorspace. Only if
the colorspace is Log do we apply the gamma and black/white points to convert
to the RGB colorspace. Its possible the program you are using is not
conforming to the SMPTE standard or ImageMagick is not interpreting the
standard correctly. Post an URL to your two DPX images and we will download and
try to determine if ImageMagick has a bug or if the program you are using is
buggy.

The following will work with ImageMagick 6.3.8-3

  magick -colorspace log AfterEffectsFile.dpx -set gamma 0.5 \
          -set reference-black 95 -set reference-white 685 image.jpg

Alternatively, take a look at the SMTPE documentation
-- Cristy


You can add text user data to the dpx file by using

  magick image.dpx   -set dpx:userdata "some text"    new.dpx

-- Cristy

</PRE>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="psd"></A>
<H3>PSD</H3>

A PSD image file is the Photoshop Working image file format, just as XCF is the
GIMP working file format,  and <A HREF="../files/#miff" >MIFF</A> is
ImageMagick's own working file format. </P>

They usually contain multi-images, with first image being an all-in-one merger
of the current working image. That makes it useful for seeing the working
image as it currently stands and is typically used for 'thumbnailing'. </P>

All the other images in the multi-image file format are the images that are
used to generate that first combined image.  That is the individual working
layer images, the user was working on at the time it was saved. </P>

So if you just want the 'final' image I suggest you append a
"&nbsp;<CODE>'[0]'</CODE>&nbsp;" to the input filename to junk the working
images, and just use the all-in-one first image. </P>

However if you plan to work with the individual layer images then use
"&nbsp;<CODE>'[1--1]'</CODE>&nbsp;" to skip the first image.  If no extra
layer images are found than the first image will be returned instead. I do NOT
recommend using "<CODE>-delete 0</CODE>" as that will return no images at all
if no layer images follow that first image. </P>

Extra notes...  If you can provide more information or like to submit a
summary of using IM for this format, then please do... </P>
<PRE>
   For PSD with a CMYK image you may need to get IM to use the
   right provide when converting (make sure you IM was installed with the LCMS
   delegate library) ....

     magick Test_CMYK.psd -strip -profile USWebCoatedSWOP.icc \
             -profile sRGB.icc Test_RGB.png

   See <A HREF="#profiles" >Profiles</A> above for more info.


   If a PSD image contain a 'preview' image.  This image is returned as the
   last image of a two image read.

   To ensure IM never reads the last image use...
       magick test.psd[0--2] -flatten test.jpg
   That is read all images, except the last. But always read the first.
   This can not be done after the read using a "-delete".
</PRE>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="wmf"></A>
<H3>WMF</H3>

Another vector format often used for scalable clipart used by the Microsoft
Office set of programs.  The input can be scaled changing the "<CODE><A
HREF="../option_link.cgi?density" >-density</A></CODE>" before reading the
image.  </P>

See also <A HREF="#vector" >Vector Image Formats</A>.</P>


<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="swf"></A>
<H3>Flash Animations (SWF)</H3>

Flash animations are currently not supported by IM. </P>

But just for completeness <I>Scott Bicknell</I> reports that the <A
HREF="http://www.swftools.org/" >SWF Tool</A> utility
"<CODE>swfextract</CODE>" It can extract jpeg or png frames from a flash
animation. </P>

<I>Wolfgang Hugemann</I> also thinks the Windows freeware tool
"<CODE>IrfanView</CODE>" may be able to do this as well. </P>

Sounds like a good delegate candidate to me. </P>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="html"></A>
<H3>Webpage Conversion to Image (HTML)</H3>

If IM loads a HTML it will look for a html2ps to magick the html to
postscript which it can then render as an image. This does not work very well,
but does work. </P>

Using a full web browser is a much better method as it is designed to do the
task in the best possible way. The simplest method to use a browser is to just
load the page in a browser and then take a screen shot of it.  This gets a
perfect image of the page but limited to the window size of the browser. </P>

Another variation is to have the browser output the page as postscript rather than
have IM magick it. This should page the website into smaller pages quite
nicely. </P>

Under LINUX you can to start a virtual X windows Display server that is large
enough to run a browser that shows the whole web site. This can be a VERY tall
display. The browser is then run in it and set to fill the entire display. The
web site is loaded and again grabs a screen shot. I have seen a script that
can even automate that whole complex process. However you can end up with a
VERY long image.  It is also difficult to know just how big to make the
display. </P>

Basically it is NOT easy and the best solutions only use IM for the final image
processing, not the html to image generation. </P>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="pcl"></A>
<H3>PCL Printing Format</H3>

IM PCL is version 6 PCL by default. </P>

For version 5 you need to magick your image to black and white. </P>

For example...
<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick image.png -monochrome image.pcl
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="pcd"></A>
<H3>Kodak PhotoCD or ProPhotoCD (PCD)</H3>

The Kodak PhotoCD file is a multi resolution image file format. That is each
file contains the same image at 6 different sizes forming something known as
a 'pyramid image'.  First image in the file is the lowest resolution (smallest
size) and the last the highest resolution (largest size at 3072&times;2048
pixels). </P>

As users typically what the largest resolution image for processing the way to
magick a PCD image to some other format like JPG is to grab the sixth or
(index 5) from the image file. </P>

For example...
<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick -colorspace RGB image.pcd[5] image.jpg
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

The "<CODE>-colorspace RGB</CODE>" option is needed in order to get the colors
right. </P>

Information courtesy of Wolfgang Hugemann &lt;ImageMagick_AT_Hugemann.de&gt;
from the Magick-Users Mailing list. </P>

<HR WIDTH=50% ALIGN=center><!-- ---------------------------------- -->

<A NAME="gray"></A>
<A NAME="rgb"></A>
<H3>Raw RGB, and Gray Data</H3>

Imagemagick has a some file formats for dealing with raw image data,
specifically "<CODE>RGB:</CODE>", and "<CODE>GRAY:</CODE>".  As well as
provide settings defining that data. </P>

For example to output RGB raw data...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick image.jpg -depth 8  image.rgb
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

The "<CODE><A HREF="../option_link.cgi?depth" >-depth</A></CODE>" setting
specifies the size of the integers written (and later read). In this case
8 bit values with 3 bytes per pixel for RGB, (a 24 bit image). Specifying an
appropriate depth is always recomended for handlign raw image data.  </P>

A "<CODE><A HREF="../option_link.cgi?depth" >-depth</A></CODE>" of 16
bits, will produce 2 bytes per value, in which case you may also need to
specify the "<CODE><A HREF="../option_link.cgi?endian" >-endian</A></CODE>" or
byte order, to be either '<CODE>MSB</CODE>' (most significate byte first), or
'<CODE>LSB</CODE>' (least significate byte first, the default). </P>

Note that rgb is purely the image data, it does not even contain the width and
the height of the image!  Some applications 'assume' the data is a specific
size, so you may need to use IM to ensure that data is this size. </P>

For example This resizes and pads the image to ensure it is 512x512 pixels in
size.

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick image.jpg -resize \>512x512 \
          -background black -gravity center -extent 512x512 \
          -depth 8  image.rgb
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

When reading raw RGB (or GRAY) data into ImageMagick you will need to specify
how big the image is.  For example..

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick -size 512x512 -depth 8 image.rgb    image.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

This will exactly define how much data Imagemagick will read in. </P>

Sometimes the raw data may have some extra header information attached.  To
allow IM to skip over this information you can specify an 'byte_offset' in the
"<CODE><A HREF="../option_link.cgi?size" >-size</A></CODE>" setting. </P>

For example skip a 48 byte header...

<DIV ALIGN=center>
<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=5 WIDTH=80% BGCOLOR="#CCCCCC">
<TR><TD><PRE><CODE>
  magick -size 512x512+48 -depth 8 image.rgb    image.png
</CODE></PRE></TD></TR></TABLE>
</DIV></P>

This is the only time I know of where IM will make use of a third number in
the "<CODE><A HREF="../option_link.cgi?size" >-size</A></CODE>" setting. </P>

For more examples of using raw image data (grayscale) see the IM Discussion
forum topic <A HREF="../forum_link.cgi?f=1&t=20324&p=80891" >How to convert
raw image to compressed tif?</A>. </P>

<H4>Floating Point Data</H4>

<PRE>You can also read (and write) RGB using normalized floating point numbers.
This however requires the use of special coder -define settings.
See HDRI floating point file formats
   https://imagemagick.org/Usage/basics/#hdri_formats


RGB floating point Image generated using C Code (HDRI)...

   float red = 1.0f;
   float green = 1.0f;   /* appropriate data */
   float blue = 1.0f;

   /* for exach pixel in image... */
   fwrite (&red, sizeof(float), 1, file);
   fwrite (&green, sizeof(float), 1, file);
   fwrite (&blue, sizeof(float), 1, file);

Reading Options....

  magick -size 200x100 -depth 32 -define quantum:format=floating-point
          -define quantum:scale=65536.0   -endian lsb   input.rgb
          output.png

The quantum:format defines to read floating point numbers from the file.
While the -depth defines the floating point size (32 = floats, 64 = doubles).

The quantum:scale  defines how to scale the floating point numbers from
normalized 0.0 to 1.0 values to the in-memory 16bit Quality levels needed
by my Q16 version of IM.

</PRE>

<o/DIV></P>
<HR><!-- ---------------------------------------------------------------- -->
</div></main><footer class="magick-footer"><div class="container-fluid">
Created: 9 December 2003 <BR>
Updated: 13 Feburary 2012 <BR>
Author: <A HREF="https://antofthy.gitlab.io/anthony.html"
        >Anthony Thyssen</A>, &lt;Anthony.Thyssen&#64;gmail.com&gt;<BR>
Examples Generated with:
        <IMG SRC="version.gif" ALIGN=absmiddle ALT="[version image]"><BR>
URL: <CODE>https://imagemagick.org/Usage/formats/</CODE>
</div></footer></body></HTML>

